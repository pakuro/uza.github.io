<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>War Strategy: BOSS BATTLE</title>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: 'Arial Black', sans-serif; user-select: none; }
        
        canvas { display: block; width: 100vw; height: 100vh; background: #87CEEB; }

        /* UI */
        #ui-layer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 130px;
            background: rgba(0,0,0,0.85); border-top: 4px solid #fff;
            display: flex; justify-content: center; align-items: center; gap: 15px;
            padding-bottom: 10px; z-index: 10;
        }

        .btn {
            width: 110px; height: 90px;
            background: #444; color: white; border: 2px solid #666; border-radius: 8px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; transition: 0.1s;
            box-shadow: 0 4px 0 #222;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; background: #555; }
        .btn.disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); transform: none; box-shadow: none;}
        .cost { color: #ffff00; font-size: 14px; margin-top: 5px; }
        .name { font-size: 16px; font-weight: bold; }
        
        #btn-upgrade { background: #0055aa; border-color: #0077cc; }

        #money-display {
            position: absolute; top: -60px; left: 20px;
            color: #ffff00; font-size: 40px; text-shadow: 3px 3px 0 #000;
            font-family: 'Courier New', monospace; font-weight: bold;
        }

        /* Ë≠¶ÂëäË°®Á§∫ */
        #warning-msg {
            position: absolute; top: 30%; width: 100%; text-align: center;
            color: red; font-size: 80px; font-weight: bold; 
            text-shadow: 0 0 10px yellow; display: none; z-index: 50;
            animation: blink 0.5s infinite alternate;
        }
        @keyframes blink { from {opacity: 1;} to {opacity: 0;} }

        /* ÁµÇ‰∫ÜÁîªÈù¢ */
        #overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; display: none;
        }
        #overlay h1 { font-size: 60px; margin: 0; text-transform: uppercase; letter-spacing: 5px; }
        #restart-btn {
            margin-top: 30px; padding: 15px 50px; font-size: 24px; cursor: pointer;
            background: #fff; color: #000; border: none; font-weight: bold;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="warning-msg">WARNING!!<br>BOSS APPROACHING</div>

    <div id="ui-layer">
        <div id="money-display">MONEY: $0</div>
        
        <div class="btn" id="btn-soldier" onclick="spawnPlayerUnit('soldier')">
            <div class="name">SOLDIER</div>
            <div class="cost">$50</div>
        </div>
        
        <div class="btn" id="btn-tank" onclick="spawnPlayerUnit('tank')">
            <div class="name">TANK</div>
            <div class="cost">$200</div>
        </div>

        <div class="btn" id="btn-sniper" onclick="spawnPlayerUnit('sniper')">
            <div class="name">SNIPER</div>
            <div class="cost">$350</div>
        </div>

        <div style="border-left: 2px solid #666; height: 60px; margin: 0 10px;"></div>

        <div class="btn" id="btn-upgrade" onclick="upgradeWallet()">
            <div class="name">UPGRADE</div>
            <div class="cost" id="upg-cost">$500</div>
        </div>
    </div>

    <div id="overlay">
        <h1 id="result-text">VICTORY</h1>
        <button id="restart-btn" onclick="location.reload()">PLAY AGAIN</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const UNIT_TYPES = {
            soldier: { cost: 50,  hp: 60,  dmg: 12, range: 40,  speed: 2,   reload: 40,  bounty: 30,  color: '#33ff33', w: 10, h: 20 },
            tank:    { cost: 200, hp: 450, dmg: 45, range: 70,  speed: 1,   reload: 100, bounty: 150, color: '#3366ff', w: 40, h: 30 },
            sniper:  { cost: 350, hp: 50,  dmg: 90, range: 280, speed: 1.5, reload: 120, bounty: 200, color: '#ff33ff', w: 10, h: 25 }
        };

        let gameState = 'playing';
        let frame = 0;
        let money = 500; 
        let moneyRate = 2; // „ÅäÈáë„Ç∂„ÇØ„Ç∂„ÇØ
        let upgradeCost = 500;
        
        const GROUND_Y = window.innerHeight - 180;
        
        // „Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ
        let units = [];
        let particles = [];
        let projectiles = [];
        let floatingTexts = [];
        let boss = null;
        let bossSpawned = false;

        const basePlayer = { x: 50, hp: 5000, maxHp: 5000, team: 'player', color: '#00ccff', w:60 };
        const baseEnemy = { x: window.innerWidth - 100, hp: 5000, maxHp: 5000, team: 'enemy', color: '#ff3333', w:60 };

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            baseEnemy.x = canvas.width - 100;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- „ÇØ„É©„ÇπÂÆöÁæ© ---

        // ÈÄöÂ∏∏„É¶„Éã„ÉÉ„Éà
        class Unit {
            constructor(type, team) {
                const data = UNIT_TYPES[type];
                this.type = type;
                this.team = team;
                
                const buff = (team === 'player') ? 1.5 : 1.0; // „Éó„É¨„Ç§„É§„Éº„Åã„Å™„ÇäÂº∑„ÅÑ
                
                this.maxHp = data.hp * buff;
                this.hp = this.maxHp;
                this.dmg = data.dmg * buff;
                this.range = data.range;
                this.speed = data.speed;
                this.reloadTime = data.reload;
                this.color = data.color;
                this.w = data.w;
                this.h = data.h;
                this.bounty = data.bounty;
                this.cooldown = 0;
                this.state = 'move';
                this.dead = false;

                if (team === 'player') {
                    this.x = basePlayer.x + 60;
                    this.vx = this.speed;
                } else {
                    this.x = baseEnemy.x - 60;
                    this.vx = -this.speed;
                }
                this.y = GROUND_Y - this.h;
            }

            update() {
                if(this.dead) return;

                let target = null;
                let minDist = 9999;
                const enemyTeam = (this.team === 'player') ? 'enemy' : 'player';

                // „Éú„Çπ„ÇÇ„Çø„Éº„Ç≤„ÉÉ„ÉàÂØæË±°
                const targets = [...units];
                if (boss && boss.hp > 0 && this.team === 'player') targets.push(boss);

                for(let u of targets) {
                    if (u.team === enemyTeam && !u.dead) {
                        const dist = Math.abs(u.x - this.x);
                        if (dist < minDist) {
                            minDist = dist;
                            target = u;
                        }
                    }
                }

                // Âü∫Âú∞„Çø„Éº„Ç≤„ÉÉ„Éà
                const baseTarget = (this.team === 'player') ? baseEnemy : basePlayer;
                const baseDist = Math.abs(baseTarget.x - this.x);
                if (baseDist < minDist) {
                    minDist = baseDist;
                    target = baseTarget;
                    target.isBase = true;
                }

                if (target && minDist <= this.range) {
                    this.state = 'attack';
                    this.cooldown--;
                    if (this.cooldown <= 0) {
                        this.attack(target);
                        this.cooldown = this.reloadTime;
                    }
                } else {
                    this.state = 'move';
                    this.x += this.vx;
                    this.cooldown = Math.max(0, this.cooldown - 1);
                }
            }

            attack(target) {
                projectiles.push(new Projectile(this.x, this.y + this.h/2, target, this.dmg, this.team, 'bullet'));
            }

            takeDamage(amount, attackerTeam) {
                this.hp -= amount;
                spawnParticles(this.x, this.y + this.h/2, 2, '#fff');
                
                if (this.hp <= 0 && !this.dead) {
                    this.dead = true;
                    if (this.team === 'enemy' && attackerTeam === 'player') {
                        money += this.bounty;
                        spawnFloatingText(this.x, this.y - 20, "+$" + this.bounty, '#ffff00');
                    }
                }
            }

            draw() {
                ctx.fillStyle = (this.team === 'enemy') ? '#ff5555' : this.color;
                ctx.fillRect(this.x - this.w/2, this.y, this.w, this.h);
                // HP
                const pct = Math.max(0, this.hp / this.maxHp);
                ctx.fillStyle = '#444'; ctx.fillRect(this.x-10, this.y-8, 20, 4);
                ctx.fillStyle = (this.team==='player')?'#00ff00':'#f00'; ctx.fillRect(this.x-10, this.y-8, 20*pct, 4);
            }
        }

        // üëπ „Éú„Çπ„ÇØ„É©„Çπ
        class Boss {
            constructor() {
                this.x = baseEnemy.x; 
                this.y = GROUND_Y - 120; // „Éá„Ç´„Ç§
                this.w = 100;
                this.h = 120;
                this.team = 'enemy';
                this.hp = 15000; // Ë∂Ö„Çø„Éï
                this.maxHp = 15000;
                this.color = '#800080'; // Á¥´
                this.dead = false;
                
                this.state = 'walk'; // walk, idle, spin, missile
                this.targetX = baseEnemy.x - 200; // Â∞ë„ÅóÂâç„Å´Âá∫„Çã
                
                this.actionTimer = 0;
                this.spinAngle = 0;
            }

            update() {
                if (this.dead) return;

                // ÁôªÂ†¥„Ç∑„Éº„É≥: ÂÆö‰ΩçÁΩÆ„Åæ„ÅßÊ≠©„Åè
                if (this.state === 'walk') {
                    if (this.x > this.targetX) {
                        this.x -= 0.5;
                    } else {
                        this.state = 'combat';
                    }
                } 
                else if (this.state === 'combat') {
                    this.actionTimer++;

                    // ‰∏ÄÂÆöÈñìÈöî„ÅßÊîªÊíÉ„ÇíÈÅ∏Êäû
                    if (this.actionTimer > 150) {
                        const r = Math.random();
                        if (r < 0.5) {
                            this.performSpinSlash();
                        } else {
                            this.performMissile();
                        }
                        this.actionTimer = 0;
                    }
                }

                // „Çπ„Éî„É≥„Ç®„Éï„Çß„ÇØ„ÉàÁî®
                if (this.spinAngle > 0) this.spinAngle -= 0.2;
            }

            performSpinSlash() {
                // ÂõûËª¢Êñ¨„Çä: Âë®Âõ≤„ÅÆÊïµ„ÇíÂêπ„ÅçÈ£õ„Å∞„Åô
                this.spinAngle = Math.PI * 2; // „Ç®„Éï„Çß„ÇØ„ÉàÈñãÂßã
                spawnFloatingText(this.x, this.y - 130, "SPIN SLASH!!", "#ff0000");

                // ÁØÑÂõ≤ÊîªÊíÉÂà§ÂÆö
                units.forEach(u => {
                    if (u.team === 'player' && Math.abs(u.x - this.x) < 150) {
                        u.takeDamage(100, 'enemy'); // Â§ß„ÉÄ„É°„Éº„Ç∏
                        u.x -= 100; // „Éé„ÉÉ„ÇØ„Éê„ÉÉ„ÇØ
                    }
                });
            }

            performMissile() {
                // „Éü„Çµ„Ç§„É´: ‰∏ÄÁï™ÈÅ†„ÅÑÊïµ„ÄÅ„ÅÇ„Çã„ÅÑ„ÅØÂü∫Âú∞„ÇíÁãô„ÅÜ
                spawnFloatingText(this.x, this.y - 130, "MISSILE!!", "#ffaa00");
                
                // „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏ÂÆö
                let target = basePlayer;
                // „Åü„Åæ„Å´„É¶„Éã„ÉÉ„Éà„ÇíÁãô„ÅÜ
                const playerUnits = units.filter(u => u.team === 'player');
                if (playerUnits.length > 0) {
                    target = playerUnits[Math.floor(Math.random() * playerUnits.length)];
                }

                projectiles.push(new Projectile(this.x, this.y + 40, target, 200, 'enemy', 'missile'));
            }

            takeDamage(amount, attackerTeam) {
                this.hp -= amount;
                spawnParticles(this.x + (Math.random()-0.5)*80, this.y + (Math.random())*100, 2, '#fff');
                if (this.hp <= 0 && !this.dead) {
                    this.dead = true;
                    money += 5000;
                    spawnFloatingText(this.x, this.y, "BOSS DEFEATED!", "#gold");
                    // „Éú„Çπ„ÅåÊ≠ª„Çì„Å†„ÇâÂü∫Âú∞„ÇÇÁàÜÁô∫
                    baseEnemy.hp = 0; 
                }
            }

            draw() {
                // Êú¨‰Ωì
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x - this.w/2, this.y, this.w, this.h);
                
                // È°îÔºàÊÄñ„ÅÑÈ°îÔºâ
                ctx.fillStyle = '#000';
                ctx.fillRect(this.x - 20, this.y + 30, 10, 10); // ÁõÆ
                ctx.fillRect(this.x + 10, this.y + 30, 10, 10); // ÁõÆ
                ctx.fillStyle = 'red';
                ctx.fillRect(this.x - 30, this.y + 60, 60, 5); // Âè£

                // HP„Éê„Éº
                const pct = Math.max(0, this.hp / this.maxHp);
                ctx.fillStyle = '#000';
                ctx.fillRect(this.x - 60, this.y - 20, 120, 15);
                ctx.fillStyle = 'purple';
                ctx.fillRect(this.x - 60, this.y - 20, 120 * pct, 15);
                ctx.strokeStyle = '#fff';
                ctx.strokeRect(this.x - 60, this.y - 20, 120, 15);
                ctx.fillStyle = '#fff';
                ctx.font = "bold 12px Arial";
                ctx.fillText("BOSS", this.x - 15, this.y - 25);

                // ÂõûËª¢Êñ¨„Çä„Ç®„Éï„Çß„ÇØ„Éà
                if (this.spinAngle > 0.1) {
                    ctx.save();
                    ctx.translate(this.x, this.y + this.h/2);
                    ctx.rotate(this.spinAngle);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.beginPath();
                    ctx.arc(0, 0, 140, 0, Math.PI*2);
                    ctx.fill();
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 10;
                    ctx.stroke();
                    ctx.restore();
                }
            }
        }

        class Projectile {
            constructor(x, y, target, dmg, team, type) {
                this.x = x; this.y = y; this.target = target;
                this.dmg = dmg; this.team = team; this.type = type;
                this.active = true;
                
                if (type === 'missile') {
                    this.speed = 6;
                } else {
                    this.speed = 12;
                }

                // ÁõÆÊ®ôÂú∞ÁÇπË®àÁÆó
                const tx = (target.isBase) ? target.x : target.x;
                const ty = (target.isBase) ? (GROUND_Y - 40) : (target.y + 10);
                const dx = tx - x; const dy = ty - y;
                const d = Math.sqrt(dx*dx + dy*dy);
                this.vx = (dx/d) * this.speed; 
                this.vy = (dy/d) * this.speed;
            }

            update() {
                this.x += this.vx; this.y += this.vy;
                
                // „Éü„Çµ„Ç§„É´„ÅØÁÖô„ÇíÂá∫„Åô
                if (this.type === 'missile') {
                    spawnParticles(this.x, this.y, 1, 'gray');
                }

                let hit = false;
                
                // „Çø„Éº„Ç≤„ÉÉ„Éà„Å®„ÅÆË∑ùÈõ¢Âà§ÂÆö
                // „Éü„Çµ„Ç§„É´„ÅØÁØÑÂõ≤ÁàÜÁô∫„Åï„Åõ„Åü„ÅÑ„Åå„ÄÅÁ∞°ÊòìÁöÑ„Å´„Çø„Éº„Ç≤„ÉÉ„ÉàÁõ¥ÊíÉ„Å´„Åô„Çã
                let distThreshold = (this.type === 'missile') ? 30 : 20;

                let tx = this.target.x;
                let ty = this.target.y + (this.target.h ? this.target.h/2 : 0);
                if (this.target.isBase) { ty = GROUND_Y - 50; }

                if (Math.abs(this.x - tx) < distThreshold && Math.abs(this.y - ty) < distThreshold) {
                    hit = true;
                } else if (this.y > GROUND_Y) {
                    hit = true; // Âú∞Èù¢Ë°ùÁ™Å
                }

                if (hit) {
                    this.active = false;
                    if (this.type === 'missile') {
                        // ÁàÜÁô∫„Ç®„Éï„Çß„ÇØ„Éà
                        spawnParticles(this.x, this.y, 20, 'orange');
                        // „Çø„Éº„Ç≤„ÉÉ„Éà„Å´Â§ß„ÉÄ„É°„Éº„Ç∏
                        if (this.target && this.target.hp > 0) {
                            this.target.isBase ? (this.target.hp -= this.dmg) : this.target.takeDamage(this.dmg, this.team);
                        }
                        // Âë®Âõ≤„Å´„ÇÇ„ÉÄ„É°„Éº„Ç∏ÔºàÁ∞°ÊòìÔºâ
                        units.forEach(u => {
                            if (u.team !== this.team && Math.abs(u.x - this.x) < 80) {
                                u.takeDamage(this.dmg / 2, this.team);
                            }
                        });

                    } else {
                        spawnParticles(this.x, this.y, 3, 'yellow');
                        if (this.target && !this.target.dead) {
                             if(this.target.isBase) this.target.hp -= this.dmg;
                             else this.target.takeDamage(this.dmg, this.team);
                        }
                    }
                }
            }
            
            draw() {
                if (this.type === 'missile') {
                    ctx.fillStyle = 'red';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 8, 0, Math.PI*2);
                    ctx.fill();
                    ctx.fillStyle = 'orange'; // Â∞æ
                    ctx.fillRect(this.x - this.vx*2, this.y - this.vy*2, 6, 6);
                } else {
                    ctx.fillStyle = '#ffff00';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, 4, 0, Math.PI*2);
                    ctx.fill();
                }
            }
        }

        class FloatingText {
            constructor(x, y, text, color) { this.x=x; this.y=y; this.text=text; this.color=color; this.life=1.0; this.vy=-1.5; }
            update() { this.y+=this.vy; this.life-=0.02; }
            draw() {
                ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle = this.color;
                ctx.font = "bold 24px Arial"; ctx.strokeStyle="black"; ctx.lineWidth=3;
                ctx.strokeText(this.text, this.x, this.y); ctx.fillText(this.text, this.x, this.y);
                ctx.globalAlpha = 1.0;
            }
        }
        class Particle {
            constructor(x, y, color) { this.x=x; this.y=y; this.color=color; this.vx=(Math.random()-0.5)*6; this.vy=(Math.random()-0.5)*6; this.life=1.0; }
            update() { this.x+=this.vx; this.y+=this.vy; this.life-=0.05; }
            draw() { ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle=this.color; ctx.fillRect(this.x, this.y, 5, 5); ctx.globalAlpha=1.0; }
        }
        function spawnParticles(x, y, c, col) { for(let i=0; i<c; i++) particles.push(new Particle(x,y,col)); }
        function spawnFloatingText(x, y, txt, col) { floatingTexts.push(new FloatingText(x, y, txt, col)); }

        function spawnPlayerUnit(type) {
            if (gameState !== 'playing') return;
            const cost = UNIT_TYPES[type].cost;
            if (money >= cost) {
                money -= cost;
                units.push(new Unit(type, 'player'));
            }
        }

        function upgradeWallet() {
            if (money >= upgradeCost) {
                money -= upgradeCost;
                moneyRate += 1; 
                upgradeCost += 500;
                document.getElementById('upg-cost').innerText = "$" + upgradeCost;
                spawnFloatingText(basePlayer.x, basePlayer.y - 100, "LEVEL UP!!", "#00ffff");
            }
        }

        let enemyTimer = 0;
        function updateGame() {
            if (gameState !== 'playing') return;
            frame++;

            // „ÅäÈáëÂ¢óÂä†
            if (frame % 6 === 0) money += moneyRate;
            document.getElementById('money-display').innerText = "MONEY: $" + Math.floor(money);
            
            // „Éú„Çø„É≥Âà∂Âæ°
            ['soldier', 'tank', 'sniper'].forEach(type => {
                const btn = document.getElementById('btn-'+type);
                if (money >= UNIT_TYPES[type].cost) btn.classList.remove('disabled');
                else btn.classList.add('disabled');
            });
            const upgBtn = document.getElementById('btn-upgrade');
            if (money >= upgradeCost) upgBtn.classList.remove('disabled');
            else upgBtn.classList.add('disabled');

            // --- ÊïµÂá∫Áèæ„É≠„Ç∏„ÉÉ„ÇØ ---
            enemyTimer++;
            let spawnInterval = 150 - (frame / 500); 
            if(spawnInterval < 80) spawnInterval = 80;

            if (enemyTimer > spawnInterval) {
                const r = Math.random();
                let type = 'soldier';
                if (r < 0.3) type = 'tank';
                if (r < 0.1) type = 'sniper';
                units.push(new Unit(type, 'enemy'));
                enemyTimer = 0;
            }

            // --- „Éú„ÇπÂá∫Áèæ„ÉÅ„Çß„ÉÉ„ÇØ ---
            // „Éó„É¨„Ç§„É§„Éº„ÅÆ„É¶„Éã„ÉÉ„Éà„ÅåÁîªÈù¢„ÅÆ3/4 (width * 0.75) „ÇíË∂Ö„Åà„Åü„ÇâÂá∫Áèæ
            if (!bossSpawned) {
                const invasionLine = canvas.width * 0.75;
                const encroaching = units.some(u => u.team === 'player' && u.x > invasionLine);
                
                if (encroaching) {
                    bossSpawned = true;
                    boss = new Boss();
                    // Ë≠¶ÂëäË°®Á§∫
                    const w = document.getElementById('warning-msg');
                    w.style.display = 'block';
                    setTimeout(() => w.style.display = 'none', 3000);
                }
            }

            // --- „Ç¢„ÉÉ„Éó„Éá„Éº„Éà ---
            units.forEach(u => u.update());
            units = units.filter(u => !u.dead);

            if (boss) {
                boss.update();
                if (boss.dead) boss = null;
            }

            projectiles.forEach(p => p.update());
            projectiles = projectiles.filter(p => p.active);

            particles.forEach(p => p.update());
            particles = particles.filter(p => p.life > 0);

            floatingTexts.forEach(t => t.update());
            floatingTexts = floatingTexts.filter(t => t.life > 0);

            if (basePlayer.hp <= 0) endGame(false);
            if (baseEnemy.hp <= 0) endGame(true);
        }

        function draw() {
            const grd = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grd.addColorStop(0, "#00BFFF");
            grd.addColorStop(1, "#87CEEB");
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#2d8f2d';
            ctx.fillRect(0, GROUND_Y, canvas.width, canvas.height - GROUND_Y);

            // Âü∫Âú∞
            drawBase(basePlayer);
            drawBase(baseEnemy);

            // „Éú„Çπ„ÅÆÂæå„Çç„Å´„É¶„Éã„ÉÉ„Éà„ÅåÈö†„Çå„Å™„ÅÑ„Çà„ÅÜ„ÄÅÊèèÁîªÈ†ÜÂ∫è„ÇíË™øÊï¥„Åó„Å¶„ÇÇ„Çà„ÅÑ„Åå
            // Âü∫Êú¨„ÅØÂá∫ÁèæÈ†Ü„ÅßOK„ÄÇ„Éú„Çπ„ÅØÂ§ß„Åç„ÅÑ„ÅÆ„ÅßÊúÄÂæå„Å´ÊèèÁîª„Åó„Åü„Åª„ÅÜ„ÅåËø´Âäõ„ÅåÂá∫„Çã
            units.forEach(u => u.draw());
            
            if (boss) boss.draw();

            projectiles.forEach(p => p.draw());
            particles.forEach(p => p.draw());
            floatingTexts.forEach(t => t.draw());

            requestAnimationFrame(() => {
                updateGame();
                draw();
            });
        }

        function drawBase(base) {
            ctx.fillStyle = base.color;
            ctx.beginPath();
            ctx.arc(base.x, GROUND_Y, 70, Math.PI, 0);
            ctx.fill();
            const pct = Math.max(0, base.hp / base.maxHp);
            ctx.fillStyle = '#000';
            ctx.fillRect(base.x - 50, GROUND_Y - 110, 100, 12);
            ctx.fillStyle = (pct > 0.3) ? '#00ff00' : 'red';
            ctx.fillRect(base.x - 50, GROUND_Y - 110, 100 * pct, 12);
            ctx.strokeStyle = '#fff';
            ctx.strokeRect(base.x - 50, GROUND_Y - 110, 100, 12);
        }

        function endGame(win) {
            gameState = (win) ? 'win' : 'lose';
            const ov = document.getElementById('overlay');
            const txt = document.getElementById('result-text');
            ov.style.display = 'flex';
            if (win) {
                txt.innerText = "MISSION COMPLETE!!";
                txt.style.color = "#00ffcc";
            } else {
                txt.innerText = "DEFEATED...";
                txt.style.color = "#ff3333";
            }
        }

        draw();
    </script>
</body>
</html>
