<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>BROWSER LEGENDS: SOLO</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #000; user-select: none; }
        
        /* --- HUD„É¨„Ç§„É§„Éº --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        /* ÁÖßÊ∫ñ */
        #crosshair {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            display: flex; align-items: center; justify-content: center;
        }
        .ch-dot { width: 4px; height: 4px; background: #fff; border-radius: 50%; box-shadow: 0 0 4px #fff; }
        .ch-circle { 
            position: absolute; width: 20px; height: 20px; 
            border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; 
            transition: width 0.1s, height 0.1s;
        }

        /* Â∑¶‰∏ãÔºö„Éò„É´„ÇπÔºÜ„Ç∑„Éº„É´„Éâ (APEXÈ¢® Êñú„ÇÅ„Éá„Ç∂„Ç§„É≥) */
        #player-status {
            position: absolute; bottom: 30px; left: 40px;
            display: flex; flex-direction: column; gap: 5px;
            transform: skewX(-15deg); /* Êñú„ÇÅ„Å´„Åô„Çã */
        }
        .bar-row { display: flex; align-items: center; gap: 5px; }
        .bar-label { color: #ccc; font-size: 12px; font-weight: bold; width: 50px; text-align: right; transform: skewX(15deg); }
        .bar-container {
            width: 250px; height: 14px; background: rgba(20, 20, 30, 0.6);
            border: 1px solid #555; position: relative;
        }
        #shield-fill { width: 100%; height: 100%; background: #00bfff; box-shadow: 0 0 10px #00bfff; transition: width 0.1s; }
        #health-fill { width: 100%; height: 100%; background: #fff; transition: width 0.1s; }
        .player-name { color: #fff; font-size: 18px; font-weight: 800; transform: skewX(15deg); margin-bottom: 5px; text-shadow: 0 0 5px rgba(0,0,0,0.5); }

        /* Âè≥‰∏ãÔºöÊ≠¶Âô®ÔºÜÂºæËñ¨ */
        #weapon-status {
            position: absolute; bottom: 30px; right: 40px;
            text-align: right; color: white; transform: skewX(-15deg);
        }
        #ammo-count { font-size: 48px; font-weight: 900; line-height: 1; }
        #weapon-name { font-size: 16px; color: #ff9900; font-weight: bold; letter-spacing: 2px; }
        #mag-bar { width: 150px; height: 6px; background: #333; margin-left: auto; margin-top: 5px; }
        #mag-fill { width: 100%; height: 100%; background: #ff9900; }

        /* „ÉÄ„É°„Éº„Ç∏„Éï„É≠„Éº„ÉÜ„Ç£„É≥„Ç∞„ÉÜ„Ç≠„Çπ„Éà */
        .dmg-num {
            position: absolute; font-family: 'Arial Black', sans-serif; font-weight: 900;
            font-size: 24px; pointer-events: none;
            text-shadow: 2px 2px 0 #000;
            animation: floatUp 0.8s ease-out forwards;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.2); }
        }
        /* „ÉÄ„É°„Éº„Ç∏Ëâ≤ */
        .dmg-shield { color: #00bfff; -webkit-text-stroke: 1px #005f7f; }
        .dmg-health { color: #ffffff; -webkit-text-stroke: 1px #555; }
        .dmg-head { color: #ffcc00; font-size: 32px; -webkit-text-stroke: 1px #884400; z-index: 100; }

        /* ÈÄöÁü• */
        #kill-feed {
            position: absolute; top: 100px; right: 20px;
            display: flex; flex-direction: column; align-items: flex-end; gap: 5px;
        }
        .feed-item {
            background: rgba(0,0,0,0.7); color: white; padding: 5px 10px;
            border-left: 4px solid #ff3333; font-size: 14px;
            transform: skewX(-15deg);
        }

        /* „Çπ„Çø„Éº„ÉàÁîªÈù¢ */
        #blocker {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10,10,15,0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; z-index: 20; cursor: pointer;
        }
        h1 { font-size: 72px; margin: 0; font-style: italic; letter-spacing: -2px; text-shadow: 0 0 20px #ff3333; }
        .btn-start {
            margin-top: 20px; padding: 15px 50px; font-size: 24px; font-weight: bold;
            background: #ff3333; color: white; border: none; transform: skewX(-15deg);
            cursor: pointer; transition: 0.2s;
        }
        .btn-start:hover { background: #ff6666; box-shadow: 0 0 15px #ff3333; }
        .controls { margin-top: 30px; text-align: center; color: #aaa; font-size: 14px; }
        .key { border: 1px solid #666; padding: 2px 6px; background: #222; font-weight: bold; color: #fff; }
    </style>
</head>
<body>
    <div id="ui-layer">
        <div id="crosshair">
            <div class="ch-dot"></div>
            <div class="ch-circle" id="ch-circle"></div>
        </div>

        <div id="player-status">
            <div class="player-name">LEGEND</div>
            <div class="bar-row">
                <div class="bar-container"><div id="shield-fill"></div></div>
            </div>
            <div class="bar-row">
                <div class="bar-container"><div id="health-fill"></div></div>
            </div>
        </div>

        <div id="weapon-status">
            <div id="weapon-name">R-301 CARBINE</div>
            <div id="ammo-count">28</div>
            <div id="mag-bar"><div id="mag-fill"></div></div>
        </div>

        <div id="kill-feed"></div>
    </div>

    <div id="damage-overlay"></div> <div id="blocker">
        <h1>BROWSER LEGENDS</h1>
        <button class="btn-start">CLICK TO START</button>
        <div class="controls">
            <p><span class="key">W</span><span class="key">A</span><span class="key">S</span><span class="key">D</span> ÁßªÂãï | <span class="key">SHIFT</span> „ÉÄ„ÉÉ„Ç∑„É•</p>
            <p><span class="key">C</span> „Çπ„É©„Ç§„Éá„Ç£„É≥„Ç∞ | <span class="key">SPACE</span> „Ç∏„É£„É≥„Éó</p>
            <p><span class="key">R</span> „É™„É≠„Éº„Éâ | <span class="key">Â∑¶„ÇØ„É™„ÉÉ„ÇØ</span> Â∞ÑÊíÉ</p>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.150.0/build/three.module.js';
        import { PointerLockControls } from 'https://unpkg.com/three@0.150.0/examples/jsm/controls/PointerLockControls.js';

        // --- ÂÆöÊï∞Ë®≠ÂÆö (APEX„Éï„Ç£„Éº„É´) ---
        const MOVE_SPEED = 10;
        const SPRINT_SPEED = 18;
        const SLIDE_SPEED_INIT = 28; // „Çπ„É©„Ç§„Éá„Ç£„É≥„Ç∞ÂàùÈÄü
        const JUMP_FORCE = 15;
        const GRAVITY = 35;
        const PLAYER_HEIGHT = 1.7;
        const CROUCH_HEIGHT = 1.0;
        
        // Ê≠¶Âô®Ë®≠ÂÆö (R-301È¢®)
        const MAG_SIZE = 28;
        const FIRE_RATE = 80; // ms
        const RECOIL_AMOUNT = 0.002; // ÁîªÈù¢„ÅÆË∑≥„Å≠‰∏ä„Åå„Çä
        const RECOIL_RECOVERY = 0.001;

        // --- „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ ---
        let camera, scene, renderer, controls;
        let prevTime = performance.now();
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        
        // Áä∂ÊÖã„Éï„É©„Ç∞
        let moveForward=false, moveBackward=false, moveLeft=false, moveRight=false;
        let isSprinting=false, isCrouching=false, canJump=false, isSliding=false;
        let slideVelocity = 0;

        // „Ç≤„Éº„É†„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
        const bullets = [];
        const enemies = [];
        const colliders = []; // Â£Å„ÇÑÂ∫ä

        // „Éó„É¨„Ç§„É§„Éº„Éë„É©„É°„Éº„Çø
        let hp = 100, maxHp = 100;
        let shield = 100, maxShield = 100;
        let ammo = MAG_SIZE;
        let isReloading = false;
        let lastShotTime = 0;
        let currentRecoil = 0;

        // UIË¶ÅÁ¥†
        const uiShield = document.getElementById('shield-fill');
        const uiHealth = document.getElementById('health-fill');
        const uiAmmo = document.getElementById('ammo-count');
        const uiMag = document.getElementById('mag-fill');
        const damageOverlay = document.getElementById('damage-overlay');
        const crosshairCircle = document.getElementById('ch-circle');
        
        init();
        animate();

        function init() {
            // „Ç∑„Éº„É≥
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); // Á©∫Ëâ≤ (World's EdgeÈ¢®)
            scene.fog = new THREE.Fog(0x87CEEB, 0, 150);

            // „Ç´„É°„É©
            camera = new THREE.PerspectiveCamera(80, window.innerWidth/window.innerHeight, 0.1, 1000); // FOVÂ∫É„ÇÅ
            camera.position.y = PLAYER_HEIGHT;

            // „É©„Ç§„Éà
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
            scene.add(hemiLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(50, 100, 50);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // „Ç≥„É≥„Éà„É≠„Éº„É´
            controls = new PointerLockControls(camera, document.body);
            const blocker = document.getElementById('blocker');
            const btn = document.querySelector('.btn-start');
            
            btn.addEventListener('click', () => controls.lock());
            controls.addEventListener('lock', () => blocker.style.display = 'none');
            controls.addEventListener('unlock', () => blocker.style.display = 'flex');
            scene.add(controls.getObject());

            // ÂÖ•Âäõ„Ç§„Éô„É≥„Éà
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousedown', (e) => { if(controls.isLocked && e.button===0) isFiring = true; });
            document.addEventListener('mouseup', () => isFiring = false);

            // „Éû„ÉÉ„ÉóÁîüÊàê (Â∞ÑÊíÉË®ìÁ∑¥Â†¥È¢®)
            createMap();

            // „É¨„É≥„ÉÄ„É©„Éº
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Êïµ„Çπ„Éù„Éº„É≥ („Éú„ÉÉ„Éà)
            for(let i=0; i<3; i++) spawnDummy(i);

            window.addEventListener('resize', onWindowResize);
        }

        let isFiring = false;

        function createMap() {
            // Âú∞Èù¢ (Á†ÇÂú∞)
            const groundGeo = new THREE.PlaneGeometry(1000, 1000);
            const groundMat = new THREE.MeshStandardMaterial({ color: 0xccaa88, roughness: 0.9 });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            colliders.push(ground);

            // Â≤© (ÈÅÆËîΩÁâ©)
            const boxGeo = new THREE.BoxGeometry(1,1,1);
            const boxMat = new THREE.MeshStandardMaterial({ color: 0x666666 });
            
            for(let i=0; i<20; i++) {
                const wall = new THREE.Mesh(boxGeo, boxMat);
                wall.position.set((Math.random()-0.5)*100, 2.5, (Math.random()-0.5)*100 - 20);
                wall.scale.set(5+Math.random()*5, 5, 2+Math.random()*2);
                wall.castShadow = true;
                scene.add(wall);
                colliders.push(wall);
            }
            
            // „Çπ„É≠„Éº„Éó („Çπ„É©„Ç§„Éá„Ç£„É≥„Ç∞Áî®)
            const slopeGeo = new THREE.PlaneGeometry(20, 50);
            const slopeMat = new THREE.MeshStandardMaterial({ color: 0x999999, side: THREE.DoubleSide });
            const slope = new THREE.Mesh(slopeGeo, slopeMat);
            slope.rotation.x = -Math.PI / 2 - 0.3; // ÂÇæÊñú
            slope.position.set(-20, 5, -30);
            scene.add(slope);
            colliders.push(slope);
        }

        function spawnDummy(index) {
            // „ÉÄ„Éü„Éº‰∫∫ÂΩ¢
            const group = new THREE.Group();
            
            // ‰Ωì
            const mat = new THREE.MeshPhongMaterial({ color: 0xaa2222 }); // Ëµ§„ÅÑ„ÉÄ„Éü„Éº
            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1.8), mat);
            body.position.y = 0.9;
            group.add(body);
            
            // È†≠
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.35), new THREE.MeshPhongMaterial({ color: 0x550000 }));
            head.position.y = 2.0;
            group.add(head);

            // ‰ΩçÁΩÆ
            group.position.set((index-1)*10, 0, -20);
            scene.add(group);

            enemies.push({
                mesh: group,
                hp: 100, shield: 50,
                moveDir: 1, // Â∑¶Âè≥ÁßªÂãïÁî®
                lastMove: 0,
                isDead: false
            });
        }

        function onKeyDown(e) {
            switch(e.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyD': moveRight = true; break;
                case 'Space': 
                    if(canJump) { 
                        velocity.y = JUMP_FORCE; 
                        canJump = false; 
                    }
                    break;
                case 'ShiftLeft': isSprinting = true; break;
                case 'KeyC': 
                    if(!isCrouching) startSlide();
                    isCrouching = true; 
                    break;
                case 'KeyR': reload(); break;
            }
        }
        function onKeyUp(e) {
            switch(e.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyD': moveRight = false; break;
                case 'ShiftLeft': isSprinting = false; break;
                case 'KeyC': 
                    isCrouching = false; 
                    isSliding = false; 
                    // „Åó„ÇÉ„Åå„ÅøËß£Èô§„ÅßË¶ñÁÇπ„ÇíÊàª„Åô
                    camera.position.y = PLAYER_HEIGHT;
                    break;
            }
        }

        function startSlide() {
            // ÂâçÈÄ≤‰∏≠„Åß„Çπ„Éó„É™„É≥„Éà‰∏≠„Å™„Çâ„Çπ„É©„Ç§„Éá„Ç£„É≥„Ç∞ÈñãÂßã
            if(moveForward && isSprinting) {
                isSliding = true;
                slideVelocity = SLIDE_SPEED_INIT;
                // Ë¶ñÁÇπ„Çí‰∏ã„Åí„Çã
                camera.position.y = CROUCH_HEIGHT;
            } else {
                camera.position.y = CROUCH_HEIGHT; // „Åü„Å†„ÅÆ„Åó„ÇÉ„Åå„Åø
            }
        }

        function reload() {
            if(isReloading || ammo === MAG_SIZE) return;
            isReloading = true;
            uiAmmo.style.color = "#aaa";
            document.getElementById('weapon-name').innerText = "RELOADING...";
            
            setTimeout(() => {
                ammo = MAG_SIZE;
                isReloading = false;
                uiAmmo.style.color = "#fff";
                document.getElementById('weapon-name').innerText = "R-301 CARBINE";
                updateUI();
            }, 1500); // 1.5Áßí
        }

        function createDamageText(pos, amount, type) {
            // 3DÂ∫ßÊ®ô„Çí2DÁîªÈù¢Â∫ßÊ®ô„Å´Â§âÊèõ
            const vec = pos.clone();
            vec.project(camera);

            const x = (vec.x * .5 + .5) * window.innerWidth;
            const y = (-(vec.y * .5) + .5) * window.innerHeight;

            if(vec.z > 1.0) return; // ÁîªÈù¢Â§ñÔºàÂæå„ÇçÔºâ„Å™„ÇâË°®Á§∫„Åó„Å™„ÅÑ

            const el = document.createElement('div');
            el.innerText = amount;
            el.className = 'dmg-num';
            
            // „ÇØ„É©„ÇπÂàÜ„ÅëÔºàËâ≤Ôºâ
            if(type === 'shield') el.classList.add('dmg-shield');
            else if(type === 'head') el.classList.add('dmg-head');
            else el.classList.add('dmg-health');

            el.style.left = x + 'px';
            el.style.top = y + 'px';
            
            damageOverlay.appendChild(el);
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæå„Å´ÂâäÈô§
            setTimeout(() => el.remove(), 800);
        }

        function fireWeapon() {
            if(ammo <= 0) { reload(); return; }
            ammo--;
            updateUI();
            
            // „ÇØ„É≠„Çπ„Éò„Ç¢Êã°Êï£ÊºîÂá∫
            crosshairCircle.style.width = "40px";
            crosshairCircle.style.height = "40px";
            setTimeout(() => {
                crosshairCircle.style.width = "20px";
                crosshairCircle.style.height = "20px";
            }, 100);

            // „É™„Ç≥„Ç§„É´ÔºàË¶ñÁÇπ„ÇíË∑≥„Å≠‰∏ä„Åí„ÇãÔºâ
            currentRecoil += RECOIL_AMOUNT;

            // ÂºæÈÅìË®àÁÆó
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera( new THREE.Vector2(), camera ); // ÁîªÈù¢‰∏≠Â§Æ

            // „Éû„Ç∫„É´„Éï„É©„ÉÉ„Ç∑„É•ÁöÑ„Å™ÂºæÁîüÊàê
            const bulletGeo = new THREE.BoxGeometry(0.1, 0.1, 2);
            const bulletMat = new THREE.MeshBasicMaterial({ color: 0xffffaa });
            const bullet = new THREE.Mesh(bulletGeo, bulletMat);
            bullet.position.copy(camera.position);
            bullet.position.y -= 0.2; // Â∞ë„Åó‰∏ã„Åã„Çâ
            bullet.position.add(camera.getWorldDirection(new THREE.Vector3()).multiplyScalar(1));
            bullet.quaternion.copy(camera.quaternion);
            scene.add(bullet);
            setTimeout(()=>scene.remove(bullet), 50); // ‰∏ÄÁû¨„ÅßÊ∂à„Åô

            // Âà§ÂÆö
            const intersects = raycaster.intersectObjects(scene.children, true);
            
            for(let hit of intersects) {
                // Ëá™ÂàÜËá™Ë∫´„ÇÑÂºæ„Å™„Å©„ÅØÈô§Â§ñ„Åó„Åü„ÅÑ„Åå„ÄÅ‰ªäÂõû„ÅØÁ∞°ÊòìÁöÑ„Å´Ë¶™„Ç∞„É´„Éº„Éó„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                let target = hit.object;
                while(target.parent && target.parent.type !== 'Scene') {
                    target = target.parent;
                }
                
                // ÊïµÂà§ÂÆö
                const enemy = enemies.find(e => e.mesh === target);
                if(enemy && !enemy.isDead) {
                    // „Éò„ÉÉ„Éâ„Ç∑„Éß„ÉÉ„ÉàÂà§ÂÆö (y„ÅåÈ´ò„ÅÑÂ†¥ÊâÄ)
                    const isHead = hit.point.y > enemy.mesh.position.y + 1.5;
                    let dmg = isHead ? 22 : 11; // R-301È¢®„ÉÄ„É°„Éº„Ç∏
                    
                    let type = 'health';
                    
                    // „Ç∑„Éº„É´„ÉâÂá¶ÁêÜ
                    if(enemy.shield > 0) {
                        enemy.shield -= dmg;
                        type = 'shield';
                        if(enemy.shield < 0) {
                            // „Ç∑„Éº„É´„ÉâÂâ≤„ÇåË≤´ÈÄö
                            enemy.hp += enemy.shield; // „Éû„Ç§„Éä„ÇπÂàÜ„ÇíHP„Åã„ÇâÂºï„Åè
                            enemy.shield = 0;
                            createDamageText(hit.point, "CRACKED", 'shield'); // Ââ≤„Çå„ÅüË°®Á§∫
                        }
                    } else {
                        enemy.hp -= dmg;
                        type = isHead ? 'head' : 'health';
                    }
                    
                    createDamageText(hit.point, dmg, type);

                    if(enemy.hp <= 0) {
                        enemy.isDead = true;
                        enemy.mesh.visible = false; // Ê∂à„Åô
                        
                        // „Ç≠„É´„É≠„Ç∞
                        const log = document.createElement('div');
                        log.className = 'feed-item';
                        log.innerText = "YOU üî´ DUMMY";
                        document.getElementById('kill-feed').appendChild(log);
                        setTimeout(()=>log.remove(), 3000);

                        // „É™„Çπ„Éù„Éº„É≥„Çø„Ç§„Éû„Éº
                        setTimeout(() => {
                            enemy.hp = 100; enemy.shield = 50; enemy.isDead = false; enemy.mesh.visible = true;
                        }, 5000);
                    }
                    break; // Ë≤´ÈÄö„Å™„Åó
                }
                
                // Â£Å„Å´ÂΩì„Åü„Å£„Åü„Çâ„Ç®„Éï„Çß„ÇØ„ÉàÔºàÁ∞°ÊòìÔºâ
                if(hit.distance < 100 && !enemy) {
                    break;
                }
            }
        }

        function updateUI() {
            uiShield.style.width = shield + "%";
            uiHealth.style.width = hp + "%";
            uiAmmo.innerText = ammo;
            uiMag.style.width = (ammo / MAG_SIZE * 100) + "%";
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            if(controls.isLocked) {
                const time = performance.now();
                const delta = (time - prevTime) / 1000;

                // --- 1. ÁßªÂãïÁâ©ÁêÜ ---
                velocity.x -= velocity.x * 10.0 * delta; // Êë©Êì¶
                velocity.z -= velocity.z * 10.0 * delta;
                velocity.y -= GRAVITY * delta;

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                // ÈÄüÂ∫¶Ê±∫ÂÆö
                let speed = MOVE_SPEED;
                if(isSliding) {
                    // „Çπ„É©„Ç§„Éá„Ç£„É≥„Ç∞Ê∏õË°∞
                    speed = slideVelocity;
                    slideVelocity -= 15 * delta;
                    if(slideVelocity < 5) isSliding = false; // ÈÅÖ„Åè„Å™„Å£„Åü„ÇâÁµÇ‰∫Ü
                } else if(isSprinting) {
                    speed = SPRINT_SPEED;
                } else if(isCrouching) {
                    speed = MOVE_SPEED * 0.5;
                }

                // Á©∫‰∏≠Âà∂Âæ°ÔºàÂ∞ë„ÅóÂäπ„ÅèÔºâ
                if(!canJump) speed *= 0.3; // Á©∫‰∏≠„ÅØÁßªÂãï„Åó„Å´„Åè„ÅÑ

                if (moveForward || moveBackward) velocity.z -= direction.z * speed * 10.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * speed * 10.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);
                controls.getObject().position.y += (velocity.y * delta);

                // Êé•Âú∞Âà§ÂÆöÔºàÁ∞°ÊòìÔºöy=0„ÅåÂú∞Èù¢Ôºâ
                // „Åó„ÇÉ„Åå„ÅøÊôÇ„ÅØÈ´ò„Åï„ÅåÂ§â„Çè„Çã
                let groundY = 0;
                let currentHeight = isCrouching ? CROUCH_HEIGHT : PLAYER_HEIGHT;
                
                if (controls.getObject().position.y < currentHeight) {
                    velocity.y = 0;
                    controls.getObject().position.y = currentHeight;
                    canJump = true;
                }

                // --- 2. Â∞ÑÊíÉÔºÜ„É™„Ç≥„Ç§„É´ ---
                if(isFiring && !isReloading && time - lastShotTime > FIRE_RATE) {
                    fireWeapon();
                    lastShotTime = time;
                }

                // „É™„Ç≥„Ç§„É´ÂõûÂæ©
                if(currentRecoil > 0) {
                    camera.rotation.x += currentRecoil; // Ë∑≥„Å≠‰∏ä„Åå„ÇäÈÅ©Áî®ÔºàPointerLockControls„ÅØrotation„ÇíÁõ¥Êé•„ÅÑ„Åò„Çå„Å™„ÅÑ„Åü„ÇÅÂ∑•Â§´„ÅåÂøÖË¶Å„Å†„Åå„ÄÅ„Åì„Åì„Åß„ÅØÁ∞°ÊòìÁöÑ„Å´lookAt„Ç™„Éï„Çª„ÉÉ„Éà„ÇÑcamera.rotateX„Çí‰Ωø„ÅÜÔºâ
                    // PointerLockControls„ÅÆÂÜÖÈÉ®„Éî„ÉÉ„ÉÅ„ÇíÊìç‰Ωú„Åô„Çã„ÅÆ„ÅØÈõ£„Åó„ÅÑ„Åü„ÇÅ„ÄÅ
                    // „Åì„Åì„Åß„ÅØ„ÄåË¶ã„ÅüÁõÆ„ÅÆÊè∫„Çå„Äç„Å´„Å®„Å©„ÇÅ„Çã„Åã„ÄÅcontrols.getObject().rotation.x „Çí„ÅÑ„Åò„Çã
                    // Á∞°ÊòìÂÆüË£ÖÔºöcamera.rotation.x„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Çã„ÅÆ„Åß„ÄÅcontrols„ÅÆAPI„Çí‰Ωø„ÅÜ„ÅÆ„ÅåÊ≠£ÊîªÊ≥ï„Å†„Åå...
                    // „Åì„Åì„Åß„ÅØ„ÄåÂèçÂãï„ÅßË¶ñÁÇπ„Åå‰∏ä„Å´„Åö„Çå„Çã„ÄçÊåôÂãï„ÇíÂÜçÁèæ„Åô„Çã„Åü„ÇÅ„ÄÅvelocity„Å´Âπ≤Ê∏â„Åõ„ÅöË¶ñÁÇπ„Å†„ÅëÊè∫„Çâ„Åô
                    controls.getObject().rotation.x += RECOIL_AMOUNT * (Math.random() * 0.5 + 0.5); 
                    currentRecoil = 0; // ÈÅ©Áî®„Åó„Åü„Çâ„É™„Çª„ÉÉ„Éà
                }

                // --- 3. ÊïµAI („É¨„É¨„É¨ÊíÉ„Å°ÔºöÂ∑¶Âè≥ÁßªÂãï) ---
                for(const enemy of enemies) {
                    if(enemy.isDead) continue;
                    
                    // Â∏∏„Å´„Éó„É¨„Ç§„É§„Éº„ÇíË¶ã„Çã
                    enemy.mesh.lookAt(controls.getObject().position.x, enemy.mesh.position.y, controls.getObject().position.z);
                    
                    // „É©„É≥„ÉÄ„É†„Å´Â∑¶Âè≥ÁßªÂãï (Strafing)
                    if(time - enemy.lastMove > 1000 + Math.random()*2000) {
                        enemy.moveDir *= -1;
                        enemy.lastMove = time;
                    }
                    
                    // ‰ΩçÁΩÆÊõ¥Êñ∞
                    enemy.mesh.translateX(enemy.moveDir * 3.0 * delta); // Ê®™ÁßªÂãï
                }

                prevTime = time;
            } else {
                prevTime = performance.now();
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
