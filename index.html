<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Button Action RPG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        /* å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼šã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒªé¢¨ */
        body {
            margin: 0; padding: 0;
            background: #222; color: white;
            font-family: sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
            user-select: none; /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠç¦æ­¢ */
            -webkit-user-select: none;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-container {
            position: relative;
            width: 100%; max-width: 600px;
            flex-grow: 1;
            background: #000;
            border: 2px solid #555;
            display: flex; justify-content: center; align-items: center;
        }
        canvas { display: block; width: 100%; height: 100%; object-fit: contain; }

        /* UIã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆHPãƒãƒ¼ãªã©ï¼‰ */
        .ui-overlay {
            position: absolute; top: 0; left: 0; width: 100%; padding: 10px;
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯é€é */
            box-sizing: border-box;
            display: flex; justify-content: space-between;
        }
        .bar-container { background: #333; width: 100px; height: 10px; border: 1px solid #fff; margin-bottom: 5px; }
        .bar-fill { height: 100%; transition: width 0.2s; }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¨ãƒªã‚¢ */
        #controller-area {
            width: 100%; max-width: 600px;
            height: 220px;
            background: #333;
            border-top: 4px solid #555;
            display: flex; justify-content: space-between; padding: 10px;
            box-sizing: border-box;
        }

        /* åå­—ã‚­ãƒ¼ */
        .d-pad {
            display: grid;
            grid-template-columns: 60px 60px 60px;
            grid-template-rows: 60px 60px 60px;
            gap: 5px;
            align-self: center;
        }
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ç¾¤ */
        .action-pad {
            display: grid;
            grid-template-columns: 70px 70px;
            grid-template-rows: 60px 60px 50px;
            gap: 8px;
            align-self: center;
        }
        
        /* å…±é€šãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .c-btn {
            background: #444; border: 2px solid #666; border-radius: 10px;
            color: white; font-size: 24px; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 0 #222;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .c-btn:active, .c-btn.pressed {
            transform: translateY(4px); box-shadow: 0 0 0 #222; background: #666;
        }
        
        /* ç‰¹å®šãƒœã‚¿ãƒ³ã®è‰² */
        .btn-atk { background: #d32f2f; border-color: #ff5252; } /* èµ¤ */
        .btn-skill { background: #1976d2; border-color: #448aff; } /* é’ */
        .btn-item { background: #388e3c; border-color: #66bb6a; font-size: 14px; flex-direction: column;} /* ç·‘ */
        .btn-menu { background: #fbc02d; color: #000; font-size: 14px; height: 40px;}

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰ */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto;
        }
        .modal.active { display: flex; }
        .scroll-box {
            width: 80%; max-height: 60%; overflow-y: auto;
            background: #222; border: 2px solid gold; padding: 10px; margin: 10px;
        }
        .item-row { padding: 10px; border-bottom: 1px solid #444; cursor: pointer; display: flex; justify-content: space-between; }
        .item-row:hover { background: #444; }

    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div class="ui-overlay">
            <div>
                <div style="font-size:12px;">HP</div>
                <div class="bar-container"><div class="bar-fill" id="hp-bar" style="background:#f44; width:100%"></div></div>
                <div style="font-size:12px;">SP</div>
                <div class="bar-container"><div class="bar-fill" id="sp-bar" style="background:#44f; width:0%"></div></div>
            </div>
            <div style="text-align:right;">
                <div>ğŸ’ <span id="ui-gem">0</span></div>
                <div style="margin-top:5px;">
                    <button class="c-btn btn-menu" onclick="toggleMenu('gacha')">ã‚¬ãƒãƒ£</button>
                    <button class="c-btn btn-menu" onclick="toggleMenu('equip')" style="margin-top:5px;">è£…å‚™</button>
                </div>
            </div>
        </div>

        <div id="modal-gacha" class="modal">
            <h2>ğŸ”® æ­¦å™¨ã‚¬ãƒãƒ£</h2>
            <p>1å› ğŸ’100</p>
            <div id="gacha-result" style="height:50px; margin:20px; font-size:20px; color:gold;"></div>
            <button class="c-btn btn-atk" style="width:200px;" onclick="pullGacha()">ğŸ’100 å¼•ã</button>
            <br>
            <button class="c-btn" style="width:100px; height:40px; font-size:14px;" onclick="closeModal()">é–‰ã˜ã‚‹</button>
        </div>

        <div id="modal-equip" class="modal">
            <h2>ğŸ’ è£…å‚™å¤‰æ›´</h2>
            <div id="current-equip" style="margin-bottom:10px; color:#aaa;"></div>
            <div class="scroll-box" id="inventory-list"></div>
            <button class="c-btn" style="width:100px; height:40px; font-size:14px;" onclick="closeModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="controller-area">
        <div class="d-pad">
            <div></div>
            <div class="c-btn" id="btn-up" data-key="up">â¬†ï¸</div>
            <div></div>
            
            <div class="c-btn" id="btn-left" data-key="left">â¬…ï¸</div>
            <div class="c-btn" style="background:#222; border:none; box-shadow:none; cursor:default;"></div>
            <div class="c-btn" id="btn-right" data-key="right">â¡ï¸</div>
            
            <div></div>
            <div class="c-btn" id="btn-down" data-key="down">â¬‡ï¸</div>
            <div></div>
        </div>

        <div class="action-pad">
            <div class="c-btn btn-atk" id="btn-atk" style="grid-column: span 2;">âš”ï¸ æ”»æ’ƒ</div>
            
            <div class="c-btn btn-skill" id="btn-skill">âš¡ï¸</div>
            <div class="c-btn btn-item" id="btn-heal" onclick="usePotion()">
                <span>ğŸ’Š</span><span id="ui-pot" style="font-size:10px">x3</span>
            </div>
        </div>
    </div>

<script>
    // --- ã‚²ãƒ¼ãƒ è¨­å®š ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // ç”»é¢ã‚µã‚¤ã‚ºèª¿æ•´
    function resize() {
        const rect = document.getElementById('game-container').getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
    }
    window.addEventListener('resize', resize);
    resize();

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿
    let player = {
        x: canvas.width/2, y: canvas.height/2, size: 15,
        color: '#00ffcc',
        hp: 100, maxHp: 100, sp: 0, maxSp: 100,
        atk: 5, spd: 4,
        gems: 500, potions: 3,
        weapon: { name: 'ç´ æ‰‹', atk: 2, rarity: 'N' },
        invincible: 0
    };

    let enemies = [];
    let particles = [];
    let texts = [];
    let inventory = [];
    
    // å…¥åŠ›çŠ¶æ…‹ç®¡ç†
    let inputState = { up: false, down: false, left: false, right: false };

    // --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å…¥åŠ›å‡¦ç† ---
    const setupBtn = (id, key) => {
        const btn = document.getElementById(id);
        const start = (e) => { e.preventDefault(); inputState[key] = true; btn.classList.add('pressed'); };
        const end = (e) => { e.preventDefault(); inputState[key] = false; btn.classList.remove('pressed'); };
        
        btn.addEventListener('mousedown', start);
        btn.addEventListener('mouseup', end);
        btn.addEventListener('mouseleave', end); // ç¯„å›²å¤–ã«å‡ºãŸæ™‚ç”¨
        btn.addEventListener('touchstart', start);
        btn.addEventListener('touchend', end);
    };

    setupBtn('btn-up', 'up');
    setupBtn('btn-down', 'down');
    setupBtn('btn-left', 'left');
    setupBtn('btn-right', 'right');

    // æ”»æ’ƒãƒœã‚¿ãƒ³
    const atkBtn = document.getElementById('btn-atk');
    const doAttack = (e) => { e.preventDefault(); atkBtn.classList.add('pressed'); playerAttack(); setTimeout(()=>atkBtn.classList.remove('pressed'), 100); };
    atkBtn.addEventListener('mousedown', doAttack);
    atkBtn.addEventListener('touchstart', doAttack);

    // å¿…æ®ºæŠ€ãƒœã‚¿ãƒ³
    const skillBtn = document.getElementById('btn-skill');
    const doSkill = (e) => { e.preventDefault(); skillBtn.classList.add('pressed'); playerSkill(); setTimeout(()=>skillBtn.classList.remove('pressed'), 100); };
    skillBtn.addEventListener('mousedown', doSkill);
    skillBtn.addEventListener('touchstart', doSkill);


    // --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---

    function playerAttack() {
        // å‰æ–¹ã«æ”»æ’ƒåˆ¤å®šã‚’å‡ºã™
        // ç°¡æ˜“çš„ã«ã€Œä¸€ç•ªè¿‘ã„æ•µã€ã«å‘ã‹ã£ã¦å¼¾ã‚’å‡ºã™ã‚ªãƒ¼ãƒˆã‚¨ã‚¤ãƒ 
        let target = null;
        let minDist = 9999;
        enemies.forEach(e => {
            const d = Math.hypot(e.x - player.x, e.y - player.y);
            if(d < minDist) { minDist = d; target = e; }
        });

        let angle = 0; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå³
        if(target) {
            angle = Math.atan2(target.y - player.y, target.x - player.x);
        } else {
            // ç§»å‹•ã—ã¦ã„ã‚Œã°ãã®æ–¹å‘ã¸
            if(inputState.left) angle = Math.PI;
            if(inputState.up) angle = -Math.PI/2;
            if(inputState.down) angle = Math.PI/2;
        }

        particles.push({
            x: player.x, y: player.y,
            vx: Math.cos(angle) * 8, vy: Math.sin(angle) * 8,
            life: 20, color: '#fff', size: 8, dmg: player.atk + player.weapon.atk, isAtk: true
        });
    }

    function playerSkill() {
        if(player.sp >= 100) {
            player.sp = 0;
            updateUI();
            // å…¨æ–¹ä½æ”»æ’ƒ
            for(let i=0; i<360; i+=15) {
                const rad = i * Math.PI / 180;
                particles.push({
                    x: player.x, y: player.y,
                    vx: Math.cos(rad) * 10, vy: Math.sin(rad) * 10,
                    life: 40, color: 'cyan', size: 5, dmg: (player.atk + player.weapon.atk) * 3, isAtk: true
                });
            }
            spawnText(player.x, player.y, "ULTIMATE!", "cyan");
        } else {
            spawnText(player.x, player.y, "No SP!", "gray");
        }
    }

    function usePotion() {
        if(player.potions > 0 && player.hp < player.maxHp) {
            player.potions--;
            player.hp = Math.min(player.maxHp, player.hp + 50);
            updateUI();
            spawnText(player.x, player.y, "Heal!", "#0f0");
        }
    }

    function update() {
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•
        if(inputState.up) player.y -= player.spd;
        if(inputState.down) player.y += player.spd;
        if(inputState.left) player.x -= player.spd;
        if(inputState.right) player.x += player.spd;

        // å£åˆ¤å®š
        player.x = Math.max(10, Math.min(canvas.width-10, player.x));
        player.y = Math.max(10, Math.min(canvas.height-10, player.y));

        if(player.invincible > 0) player.invincible--;

        // æ•µç”Ÿæˆ
        if(Math.random() < 0.02 && enemies.length < 5) {
            const angle = Math.random() * Math.PI * 2;
            enemies.push({
                x: player.x + Math.cos(angle) * 300,
                y: player.y + Math.sin(angle) * 300,
                size: 15, hp: 20 + (player.atk), maxHp: 20,
                spd: 1 + Math.random(), color: 'red'
            });
        }

        // æ•µå‡¦ç†
        enemies.forEach((e, i) => {
            const angle = Math.atan2(player.y - e.y, player.x - e.x);
            e.x += Math.cos(angle) * e.spd;
            e.y += Math.sin(angle) * e.spd;

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¥è§¦
            const dist = Math.hypot(player.x - e.x, player.y - e.y);
            if(dist < player.size + e.size && player.invincible <= 0) {
                player.hp -= 10;
                player.invincible = 30;
                spawnText(player.x, player.y, "-10", "red");
                updateUI();
                if(player.hp <= 0) {
                    alert("GAME OVER! çŸ³ã¯æ®‹ã‚Šã¾ã™");
                    player.hp = player.maxHp;
                    player.sp = 0;
                    enemies = [];
                    updateUI();
                }
            }
        });

        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«å‡¦ç†
        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i];
            p.x += p.vx; p.y += p.vy; p.life--;
            if(p.isAtk) {
                // å½“ãŸã‚Šåˆ¤å®š
                enemies.forEach((e, ei) => {
                    if(Math.hypot(p.x - e.x, p.y - e.y) < e.size + p.size) {
                        e.hp -= p.dmg;
                        p.life = 0;
                        player.sp = Math.min(player.maxSp, player.sp + 5);
                        updateUI();
                        spawnText(e.x, e.y, p.dmg, "yellow");
                        if(e.hp <= 0) {
                            enemies.splice(ei, 1);
                            player.gems += 20;
                            spawnText(e.x, e.y, "+20 Gem", "gold");
                            updateUI();
                        }
                    }
                });
            }
            if(p.life <= 0) particles.splice(i, 1);
        }
    }

    function draw() {
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
        if(player.invincible % 4 < 2) {
            ctx.fillStyle = player.color;
            ctx.beginPath(); ctx.arc(player.x, player.y, player.size, 0, Math.PI*2); ctx.fill();
        }

        // æ•µ
        enemies.forEach(e => {
            ctx.fillStyle = e.color;
            ctx.beginPath(); ctx.arc(e.x, e.y, e.size, 0, Math.PI*2); ctx.fill();
        });

        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
        particles.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
        });

        // ãƒ†ã‚­ã‚¹ãƒˆ
        texts.forEach((t, i) => {
            ctx.fillStyle = t.color;
            ctx.font = "bold 16px Arial";
            ctx.fillText(t.text, t.x, t.y);
            t.y--; t.life--;
            if(t.life<=0) texts.splice(i, 1);
        });
    }

    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function spawnText(x, y, text, color) {
        texts.push({x, y, text, color, life:30});
    }

    function updateUI() {
        document.getElementById('hp-bar').style.width = (player.hp/player.maxHp*100) + '%';
        document.getElementById('sp-bar').style.width = (player.sp/player.maxSp*100) + '%';
        document.getElementById('ui-gem').innerText = player.gems;
        document.getElementById('ui-pot').innerText = "x" + player.potions;
    }

    // --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½ ---
    function toggleMenu(type) {
        document.querySelectorAll('.modal').forEach(e => e.classList.remove('active'));
        if(type === 'gacha') document.getElementById('modal-gacha').classList.add('active');
        if(type === 'equip') {
            document.getElementById('modal-equip').classList.add('active');
            renderInventory();
        }
    }
    function closeModal() {
        document.querySelectorAll('.modal').forEach(e => e.classList.remove('active'));
    }

    function pullGacha() {
        if(player.gems < 100) return;
        player.gems -= 100;
        updateUI();

        const rarity = Math.random() < 0.1 ? 'SSR' : (Math.random() < 0.3 ? 'SR' : 'N');
        const power = rarity === 'SSR' ? 50 : (rarity === 'SR' ? 20 : 5);
        const name = rarity + "ã®å‰£";
        
        const item = { name: name, atk: power, rarity: rarity };
        inventory.push(item);
        
        const resEl = document.getElementById('gacha-result');
        resEl.innerText = `[${rarity}] ${name} (ATK+${power})`;
        resEl.style.color = rarity === 'SSR' ? 'gold' : '#fff';
    }

    function renderInventory() {
        const list = document.getElementById('inventory-list');
        list.innerHTML = "";
        
        document.getElementById('current-equip').innerText = `ç¾åœ¨: ${player.weapon.name} (ATK+${player.weapon.atk})`;

        inventory.forEach((item, idx) => {
            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `<span style="color:${item.rarity=='SSR'?'gold':(item.rarity=='SR'?'#0cf':'white')}">${item.name}</span> <span>ATK+${item.atk}</span>`;
            row.onclick = () => {
                // è£…å‚™å…¥ã‚Œæ›¿ãˆ
                inventory.push(player.weapon); // ç¾åœ¨ã®ã‚’æˆ»ã™
                player.weapon = item;
                inventory.splice(idx, 1); // æ–°ã—ã„ã®ã‚’æ¶ˆã™
                renderInventory();
            };
            list.appendChild(row);
        });
    }

    updateUI();
    loop();

</script>
</body>
</html>
