<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Block Blast 8x8 Ultimate</title>
<style>
body{
    margin:0;
    background:white;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    font-family:sans-serif;
}
#container{
    text-align:center;
}
#board{
    display:grid;
    grid-template-columns:repeat(8,50px);
    gap:4px;
    background:#222;
    padding:10px;
}
.cell{
    width:50px;
    height:50px;
    background:#eee;
}
.filled{
    border-radius:6px;
}
#pieces{
    margin-top:20px;
}
.piece{
    display:inline-block;
    margin:10px;
    cursor:pointer;
    font-size:20px;
}
button{
    margin:5px;
    padding:8px 12px;
}
</style>
</head>
<body>
<div id="container">
<h2>Block Blast 8×8</h2>
<button onclick="mode='player'">プレイヤー</button>
<button onclick="mode='ai'">超強AI</button>
<div id="board"></div>
<div id="pieces"></div>
<h3 id="status"></h3>
</div>

<script>
const size=8;
let board=[];
let pieces=[];
let selected=null;
let mode="player";
let score=0;

const shapes=[
[[1]],
[[1,1]],
[[1],[1]],
[[1,1,1]],
[[1],[1],[1]],
[[1,1],[1,1]],
[[1,1,1],[0,1,0]],
[[1,1,0],[0,1,1]]
];

function randomColor(){
    return `hsl(${Math.random()*360},70%,60%)`;
}

function init(){
    board=Array(size).fill().map(()=>Array(size).fill(0));
    score=0;
    generatePieces();
    draw();
}

function draw(){
    const b=document.getElementById("board");
    b.innerHTML="";
    for(let y=0;y<size;y++){
        for(let x=0;x<size;x++){
            const c=document.createElement("div");
            c.className="cell";
            if(board[y][x]){
                c.classList.add("filled");
                c.style.background=board[y][x];
            }
            c.onclick=()=>tryPlace(y,x);
            b.appendChild(c);
        }
    }
    drawPieces();
}

function drawPieces(){
    const p=document.getElementById("pieces");
    p.innerHTML="";
    pieces.forEach((obj,i)=>{
        const div=document.createElement("div");
        div.className="piece";
        div.onclick=()=>selected=i;
        div.innerHTML=obj.shape.map(r=>r.map(c=>c?"⬛":"⬜").join("")).join("<br>");
        div.style.color=obj.color;
        p.appendChild(div);
    });
}

function canPlace(shape,y,x,grid=board){
    for(let dy=0;dy<shape.length;dy++){
        for(let dx=0;dx<shape[0].length;dx++){
            if(shape[dy][dx]){
                if(y+dy>=size||x+dx>=size||grid[y+dy][x+dx]) return false;
            }
        }
    }
    return true;
}

function place(obj,y,x){
    for(let dy=0;dy<obj.shape.length;dy++){
        for(let dx=0;dx<obj.shape[0].length;dx++){
            if(obj.shape[dy][dx])
                board[y+dy][x+dx]=obj.color;
        }
    }
    clearLines();
}

function clearLines(){
    for(let i=0;i<size;i++){
        if(board[i].every(v=>v)) board[i].fill(0);
        if(board.map(r=>r[i]).every(v=>v)){
            for(let j=0;j<size;j++) board[j][i]=0;
        }
    }
}

function tryPlace(y,x){
    if(mode!=="player"||selected==null) return;
    let obj=pieces[selected];
    if(canPlace(obj.shape,y,x)){
        place(obj,y,x);
        pieces.splice(selected,1);
        selected=null;
        if(pieces.length==0) generatePieces();
        if(!anyMovePossible()) gameOver();
        draw();
    }
}

function anyMovePossible(){
    for(let obj of pieces){
        for(let y=0;y<size;y++){
            for(let x=0;x<size;x++){
                if(canPlace(obj.shape,y,x)) return true;
            }
        }
    }
    return false;
}

/* ===== 3ブロック保証生成（順番固定） ===== */
function generatePieces(){
    while(true){
        let trial=[];
        for(let i=0;i<3;i++){
            let shape=shapes[Math.floor(Math.random()*shapes.length)];
            trial.push({shape:shape,color:randomColor()});
        }
        if(canPlaceInOrder(trial)){
            pieces=trial;
            return;
        }
    }
}

function canPlaceInOrder(trial){
    let temp=JSON.parse(JSON.stringify(board));

    for(let obj of trial){
        let placed=false;

        for(let y=0;y<size;y++){
            for(let x=0;x<size;x++){
                if(canPlace(obj.shape,y,x,temp)){
                    simulatePlace(obj,y,x,temp);
                    clearSimLines(temp);
                    placed=true;
                    break;
                }
            }
            if(placed) break;
        }

        if(!placed) return false;
    }
    return true;
}

function simulatePlace(obj,y,x,temp){
    for(let dy=0;dy<obj.shape.length;dy++){
        for(let dx=0;dx<obj.shape[0].length;dx++){
            if(obj.shape[dy][dx])
                temp[y+dy][x+dx]="x";
        }
    }
}

function clearSimLines(temp){
    for(let i=0;i<size;i++){
        if(temp[i].every(v=>v)) temp[i].fill(0);
        if(temp.map(r=>r[i]).every(v=>v)){
            for(let j=0;j<size;j++) temp[j][i]=0;
        }
    }
}

/* ===== 超強AI ===== */
function aiMove(){
    let best=null;
    let bestScore=-Infinity;

    for(let i=0;i<pieces.length;i++){
        let obj=pieces[i];
        for(let y=0;y<size;y++){
            for(let x=0;x<size;x++){
                if(canPlace(obj.shape,y,x)){
                    let temp=JSON.parse(JSON.stringify(board));
                    simulatePlace(obj,y,x,temp);
                    let score=evaluateBoard(temp);
                    if(score>bestScore){
                        bestScore=score;
                        best={i,y,x};
                    }
                }
            }
        }
    }

    if(best){
        let obj=pieces[best.i];
        place(obj,best.y,best.x);
        pieces.splice(best.i,1);
        if(pieces.length==0) generatePieces();
        if(!anyMovePossible()) gameOver();
        draw();
    }
}

function evaluateBoard(temp){
    let score=0;

    for(let i=0;i<size;i++){
        if(temp[i].every(v=>v)) score+=100;
        if(temp.map(r=>r[i]).every(v=>v)) score+=100;
    }

    for(let y=0;y<size;y++){
        for(let x=0;x<size;x++){
            if(temp[y][x]){
                let dist=Math.abs(3.5-y)+Math.abs(3.5-x);
                score+=10-dist;
            }
        }
    }

    return score;
}

function gameOver(){
    document.getElementById("status").innerText="ゲームオーバー";
    mode="stop";
}

setInterval(()=>{ if(mode==="ai") aiMove(); },300);

init();
</script>
</body>
</html>
