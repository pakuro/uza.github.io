<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Block Blast GOD AI</title>
<style>
body{
    margin:0;
    background:#eef2f7;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    font-family:sans-serif;
}
#game{ text-align:center; }
#score{ font-size:48px; font-weight:bold; margin:10px; }
#board{
    display:grid;
    grid-template-columns:repeat(8,55px);
    gap:6px;
    background:#dcdde1;
    padding:12px;
    border-radius:15px;
}
.cell{
    width:55px;height:55px;
    background:white;
    border-radius:12px;
}
.filled{ border-radius:12px; }
button{ margin:5px;padding:6px 10px; }
.selected{ background:#ffeaa7; }
</style>
</head>
<body>

<div id="game">
    <div id="score">0</div>
    <button onclick="setAI()">AI</button>
    <button onclick="setManual()">MANUAL</button>
    <button onclick="hold()">HOLD</button>
    <div id="board"></div>
    <div id="pieces"></div>
    <div id="status"></div>
</div>

<script>
const size=8;
let board=[];
let pieces=[];
let holdPiece=null;
let holdUsed=false;
let score=0;
let combo=0;
let mode="ai";
let selected=null;
let aiBusy=false;

const shapes=[
[[1]],[[1,1]],[[1,1,1]],[[1,1,1,1]],
[[1],[1]],[[1],[1],[1]],
[[1,1],[1,1]],
[[1,0],[1,1]],
[[1,1,1],[0,1,0]]
];

function init(){
    board=Array(size).fill().map(()=>Array(size).fill(0));
    score=0;combo=0;
    holdPiece=null;
    holdUsed=false;
    generate();
    draw();
}
function randomColor(){
    return `hsl(${Math.random()*360},70%,60%)`;
}
function generate(){
    pieces=[];
    for(let i=0;i<3;i++){
        pieces.push({
            shape:shapes[Math.floor(Math.random()*shapes.length)],
            color:randomColor()
        });
    }
    holdUsed=false;
}
function draw(){
    const b=document.getElementById("board");
    b.innerHTML="";
    for(let y=0;y<size;y++){
        for(let x=0;x<size;x++){
            const c=document.createElement("div");
            c.className="cell";
            if(board[y][x]){
                c.classList.add("filled");
                c.style.background=board[y][x];
            }
            c.onclick=()=>{
                if(mode==="manual"&&selected!==null)
                    place(selected,y,x);
            };
            b.appendChild(c);
        }
    }
    drawPieces();
    document.getElementById("score").innerText=score;
}
function drawPieces(){
    const pDiv=document.getElementById("pieces");
    pDiv.innerHTML="";
    pieces.forEach((p,i)=>{
        const btn=document.createElement("button");
        btn.innerText="P"+(i+1);
        if(i===selected) btn.classList.add("selected");
        btn.onclick=()=>{ if(mode==="manual") selected=i; draw(); };
        pDiv.appendChild(btn);
    });
    if(holdPiece){
        const h=document.createElement("div");
        h.innerText="HOLDあり";
        pDiv.appendChild(h);
    }
}
function canPlace(shape,y,x,temp=board){
    for(let dy=0;dy<shape.length;dy++){
        for(let dx=0;dx<shape[0].length;dx++){
            if(shape[dy][dx]){
                if(y+dy>=size||x+dx>=size||temp[y+dy][x+dx]) return false;
            }
        }
    }
    return true;
}
function simulate(temp,p,y,x){
    let placed=0;
    for(let dy=0;dy<p.shape.length;dy++){
        for(let dx=0;dx<p.shape[0].length;dx++){
            if(p.shape[dy][dx]){
                temp[y+dy][x+dx]=1;
                placed++;
            }
        }
    }
    let lines=0;
    for(let i=0;i<size;i++){
        if(temp[i].every(v=>v)){
            lines++; temp[i].fill(0);
        }
        if(temp.map(r=>r[i]).every(v=>v)){
            lines++; for(let j=0;j<size;j++) temp[j][i]=0;
        }
    }
    return {placed,lines};
}
function evaluate(temp,totalLines){
    let filled=0,holes=0;
    for(let y=0;y<size;y++){
        for(let x=0;x<size;x++){
            if(temp[y][x]) filled++;
            else{
                let adj=0;
                if(y>0&&temp[y-1][x]) adj++;
                if(x>0&&temp[y][x-1]) adj++;
                if(y<size-1&&temp[y+1][x]) adj++;
                if(x<size-1&&temp[y][x+1]) adj++;
                if(adj>=3) holes++;
            }
        }
    }
    return filled + holes*3 - totalLines*50;
}
function place(index,y,x){
    const p=pieces[index];
    if(!canPlace(p.shape,y,x)) return;
    let gained=0;
    for(let dy=0;dy<p.shape.length;dy++){
        for(let dx=0;dx<p.shape[0].length;dx++){
            if(p.shape[dy][dx]){
                board[y+dy][x+dx]=p.color;
                gained++;
            }
        }
    }
    let lines=0;
    for(let i=0;i<size;i++){
        if(board[i].every(v=>v)){
            lines++; board[i].fill(0);
        }
        if(board.map(r=>r[i]).every(v=>v)){
            lines++; for(let j=0;j<size;j++) board[j][i]=0;
        }
    }
    if(lines>0){
        combo++;
        gained+=lines*150+combo*100;
    }else combo=0;
    if(board.flat().every(v=>!v)) gained+=2000;
    score+=gained;
    pieces.splice(index,1);
    if(pieces.length===0) generate();
    selected=null;
    draw();
}
function hold(){
    if(holdUsed) return;
    if(selected===null) return;
    let temp=pieces[selected];
    if(holdPiece){
        pieces[selected]=holdPiece;
        holdPiece=temp;
    }else{
        holdPiece=temp;
        pieces.splice(selected,1);
        if(pieces.length===0) generate();
    }
    selected=null;
    holdUsed=true;
    draw();
}
function setAI(){ mode="ai"; aiTurn(); }
function setManual(){ mode="manual"; }

function aiTurn(){
    if(mode!=="ai"||aiBusy) return;
    aiBusy=true;
    setTimeout(()=>{
        let bestMove=null;
        let bestScore=Infinity;
        const perms=[[0,1,2],[0,2,1],[1,0,2],[1,2,0],[2,0,1],[2,1,0]];
        for(let p of perms){
            let temp=JSON.parse(JSON.stringify(board));
            let totalLines=0;
            let moves=[];
            let valid=true;
            for(let idx of p){
                let placed=false;
                for(let y=0;y<size;y++){
                    for(let x=0;x<size;x++){
                        if(canPlace(pieces[idx].shape,y,x,temp)){
                            let sim=JSON.parse(JSON.stringify(temp));
                            let r=simulate(sim,pieces[idx],y,x);
                            temp=sim;
                            totalLines+=r.lines;
                            moves.push({idx,y,x});
                            placed=true;
                            break;
                        }
                    }
                    if(placed) break;
                }
                if(!placed){ valid=false; break; }
            }
            if(!valid) continue;
            let val=evaluate(temp,totalLines);
            if(val<bestScore){
                bestScore=val;
                bestMove=moves;
            }
        }
        if(!bestMove){
            document.getElementById("status").innerText="GAME OVER";
            aiBusy=false;
            return;
        }
        for(let m of bestMove){
            place(m.idx,m.y,m.x);
        }
        aiBusy=false;
        aiTurn();
    },200);
}
init();
aiTurn();
</script>
</body>
</html>
