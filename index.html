// ================================
// Poki版スコア計算を再現
// - ブロックサイズ加算
// - 1ライン消去10点
// - 同時消しボーナス
// - 連鎖（コンボ）ボーナス
// ================================
let comboCount = 0; // グローバル: 3手以内の連続消去用

function applyPlaceAndScore(piece, y, x){
  if(!canPlace(piece.shape,y,x,board)) return null;

  const placedCount = countPieceCells(piece); // ブロックのセル数
  // 盤面に色を置く
  for(let dy=0; dy<piece.shape.length; dy++){
    for(let dx=0; dx<piece.shape[0].length; dx++){
      if(piece.shape[dy][dx]) board[y+dy][x+dx] = piece.color;
    }
  }

  // ライン消去チェック
  let lines = 0;
  for(let r=0;r<size;r++){
    if(board[r].every(v=>v)){ lines++; board[r].fill(0); }
  }
  for(let c=0;c<size;c++){
    if(board.map(row=>row[c]).every(v=>v)){ lines++; for(let r=0;r<size;r++) board[r][c]=0; }
  }

  // ----------------------------
  // スコア計算
  // ----------------------------
  let gained = placedCount;        // 基本：置いたブロックのセル数
  if(lines > 0){
    gained += lines * 10;         // 1ライン消去につき10点
    if(lines >= 2){
      gained += (lines-1)*20;     // 同時消しボーナス
    }
    // 連鎖（コンボ）管理
    comboCount++;
    gained += 20 + (comboCount-1)*10; // コンボボーナス
  } else {
    comboCount = 0;               // 消去なしでコンボリセット
  }

  // 全消しボーナス（盤面が空になったら）
  const remaining = board.flat().filter(Boolean).length;
  if(remaining === 0){
    gained += 500;  // 任意の全消しボーナス
    flashAllClear();
  }

  score += gained; // スコア加算
  return { lines, remaining };
}
