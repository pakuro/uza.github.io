<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Gacha Heroes: Mugen Battle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700&display=swap');

        :root {
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --accent: #e94560;
            --text-main: #fff;
            --ssr-color: linear-gradient(135deg, #ff00cc, #3333ff, #00ccff, #ffcc00);
        }

        body {
            margin: 0; padding: 0;
            background: #0f0f1a; color: white;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            overflow: hidden;
            user-select: none;
            display: flex; justify-content: center; height: 100vh;
        }

        /* ã‚¹ãƒãƒ›ç”»é¢é¢¨ã‚³ãƒ³ãƒ†ãƒŠ */
        #app {
            width: 100%; max-width: 450px; height: 100%;
            background: var(--bg-dark);
            position: relative;
            display: flex; flex-direction: column;
            border-left: 1px solid #333; border-right: 1px solid #333;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* --- ç”»é¢å…±é€š --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column;
            padding-bottom: 70px; /* ãƒ•ãƒƒã‚¿ãƒ¼åˆ† */
            box-sizing: border-box;
            background: var(--bg-dark);
        }
        .screen.active { display: flex; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            padding: 10px 15px;
            background: rgba(0,0,0,0.8);
            border-bottom: 1px solid #444;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 10;
        }
        .currency { display: flex; gap: 15px; font-size: 14px; }
        .res-box { background: #333; padding: 4px 10px; border-radius: 15px; display: flex; align-items: center; }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .footer {
            position: absolute; bottom: 0; width: 100%; height: 60px;
            background: #222; border-top: 1px solid #444;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 20;
        }
        .menu-btn {
            background: none; border: none; color: #888;
            font-size: 10px; display: flex; flex-direction: column; align-items: center;
            cursor: pointer; width: 100%;
        }
        .menu-btn.active { color: #fff; text-shadow: 0 0 5px var(--accent); }
        .menu-btn span { font-size: 20px; margin-bottom: 2px; }

        /* --- ãƒ›ãƒ¼ãƒ ç”»é¢ --- */
        #home-screen { align-items: center; justify-content: center; background: radial-gradient(circle, #2a2a40, #000); }
        .hero-banner { font-size: 120px; filter: drop-shadow(0 0 20px rgba(255,255,255,0.3)); animation: float 3s infinite ease-in-out; }
        .quest-btn {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            color: white; border: none; padding: 15px 50px; border-radius: 30px;
            font-size: 24px; font-weight: bold; margin-top: 30px;
            box-shadow: 0 5px 15px rgba(255, 75, 43, 0.4);
            cursor: pointer; transition: transform 0.1s;
        }
        .quest-btn:active { transform: scale(0.95); }

        /* --- ã‚¬ãƒãƒ£ç”»é¢ --- */
        #gacha-screen { padding: 20px; align-items: center; }
        .gacha-machine { 
            width: 200px; height: 200px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23444"/></svg>') no-repeat center;
            background-size: contain; margin: 40px 0;
            position: relative;
        }
        .gacha-btn {
            background: linear-gradient(45deg, #11998e, #38ef7d);
            width: 90%; padding: 15px; border-radius: 10px; border: none;
            color: white; font-size: 18px; font-weight: bold; margin-bottom: 10px; cursor: pointer;
        }
        .gacha-result {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 50;
            display: none; flex-wrap: wrap; justify-content: center; align-items: center; padding: 20px;
        }
        .card {
            width: 80px; height: 110px; margin: 5px; background: #333;
            border-radius: 5px; border: 2px solid #555;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; overflow: hidden; animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        /* ãƒ¬ã‚¢åº¦æ¼”å‡º */
        .card.R { border-color: #aaa; box-shadow: 0 0 5px #aaa; }
        .card.SR { border-color: #ffd700; box-shadow: 0 0 10px #ffd700; background: radial-gradient(circle, #554400, #222); }
        .card.SSR { 
            border: 3px solid transparent; 
            background: linear-gradient(#222, #222) padding-box, var(--ssr-color) border-box; 
            box-shadow: 0 0 20px rgba(255, 0, 200, 0.5);
        }
        .card-icon { font-size: 40px; }
        .card-name { font-size: 10px; margin-top: 5px; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; }
        .new-badge { position: absolute; top: 0; right: 0; background: red; font-size: 8px; padding: 2px 4px; border-radius: 0 0 0 5px; }

        /* --- ç·¨æˆç”»é¢ --- */
        #party-screen { padding: 10px; overflow-y: auto; }
        .party-slot { display: flex; justify-content: space-around; padding: 20px 0; background: #222; border-radius: 10px; margin-bottom: 20px; }
        .slot { width: 80px; height: 80px; background: #111; border: 2px dashed #444; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; position: relative; }
        .char-list { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .char-item { background: #333; padding: 5px; border-radius: 5px; text-align: center; cursor: pointer; }
        .char-item.selected { border: 2px solid #00ff00; }

        /* --- ãƒãƒˆãƒ«ç”»é¢ --- */
        #battle-screen { background: url('https://img.freepik.com/free-vector/dark-cave-landscape_1308-48767.jpg?w=740') no-repeat center center; background-size: cover; }
        .battle-area { flex-grow: 1; position: relative; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; }
        
        /* æ•µ */
        .enemy-container { display: flex; justify-content: center; align-items: flex-end; height: 150px; position: relative; }
        .enemy { font-size: 100px; filter: drop-shadow(0 0 10px red); transition: transform 0.1s; }
        .enemy-hp { position: absolute; top: -20px; width: 200px; height: 10px; background: #333; border: 1px solid #fff; }
        .hp-bar-fill { height: 100%; background: red; width: 100%; transition: width 0.2s; }
        
        /* å‘³æ–¹ */
        .party-container { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .party-char { text-align: center; position: relative; transition: transform 0.1s; }
        .party-char span { font-size: 50px; display: block; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); }
        .char-hp { width: 50px; height: 5px; background: #333; margin: 0 auto; }
        .char-hp-fill { height: 100%; background: #00ff00; width: 100%; }

        /* ã‚³ãƒãƒ³ãƒ‰ */
        .command-panel { height: 120px; background: rgba(0,0,0,0.8); padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .cmd-btn { background: #444; color: white; border: 1px solid #666; font-size: 16px; border-radius: 5px; cursor: pointer; }
        .cmd-btn:active { background: #666; }
        .cmd-atk { background: #800; border-color: #d00; }
        .cmd-skill { background: #008; border-color: #44f; }

        /* ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .dmg-popup { position: absolute; color: white; font-size: 30px; font-weight: bold; text-shadow: 2px 2px 0 #000; pointer-events: none; animation: popUp 0.8s forwards; }
        
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        @keyframes pop { 0% { transform: scale(0); } 80% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes popUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-50px) scale(1.5); opacity: 0; } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } 100% { transform: translateX(0); } }

    </style>
</head>
<body>

<div id="app">
    <div class="header">
        <div style="font-weight:bold;">âš”ï¸ Gacha RPG</div>
        <div class="currency">
            <div class="res-box">ğŸ’° <span id="val-gold">0</span></div>
            <div class="res-box">ğŸ’ <span id="val-gem">1000</span></div>
        </div>
    </div>

    <div id="home-screen" class="screen active">
        <div class="hero-banner">ğŸ°</div>
        <div style="text-align:center; margin-top:20px;">
            <h2>å†’é™ºã¸å‡ºç™º</h2>
            <p>ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸: <span id="stage-num">1-1</span></p>
        </div>
        <button class="quest-btn" onclick="startBattle()">BATTLE START</button>
    </div>

    <div id="gacha-screen" class="screen">
        <h2>è‹±é›„å¬å–š</h2>
        <div class="gacha-machine">
            <div style="font-size:100px; text-align:center; line-height:200px;">ğŸ”®</div>
        </div>
        <button class="gacha-btn" onclick="pullGacha(1)">å˜ç™ºå¬å–š (ğŸ’300)</button>
        <button class="gacha-btn" onclick="pullGacha(10)">10é€£å¬å–š (ğŸ’3000)</button>
        <div id="gacha-result" class="gacha-result" onclick="this.style.display='none'"></div>
    </div>

    <div id="party-screen" class="screen">
        <h2>ãƒ‘ãƒ¼ãƒ†ã‚£ç·¨æˆ</h2>
        <div class="party-slot" id="party-editor">
            </div>
        <h3>æ‰€æŒã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</h3>
        <div class="char-list" id="inventory-list">
            </div>
    </div>

    <div id="battle-screen" class="screen">
        <div class="battle-area">
            <div style="color:white; text-align:center; background:rgba(0,0,0,0.5); padding:5px;">
                WAVE <span id="battle-wave">1/3</span>
            </div>
            
            <div class="enemy-container">
                <div class="enemy-hp"><div class="hp-bar-fill" id="enemy-hp-bar"></div></div>
                <div class="enemy" id="enemy-sprite">ğŸ²</div>
            </div>

            <div class="party-container" id="battle-party">
                </div>
        </div>
        <div class="command-panel" id="cmd-panel">
            <button class="cmd-btn cmd-atk" onclick="playerAction('attack')">æ”»æ’ƒ</button>
            <button class="cmd-btn cmd-skill" onclick="playerAction('skill')">ã‚¹ã‚­ãƒ«</button>
            <button class="cmd-btn" onclick="toggleAuto()">AUTO: <span id="auto-state">OFF</span></button>
            <button class="cmd-btn" onclick="surrender()">æ’¤é€€</button>
        </div>
        <div id="battle-result" class="gacha-result" style="flex-direction:column; background:rgba(0,0,0,0.85);">
            <h1 id="result-title" style="font-size:40px; color:#ffdd00;">VICTORY</h1>
            <p id="result-loot" style="font-size:20px;">ç²å¾—: ğŸ’°100 ğŸ’50</p>
            <button class="quest-btn" onclick="endBattle()">OK</button>
        </div>
    </div>

    <div class="footer">
        <button class="menu-btn active" onclick="showScreen('home-screen', this)"><span>ğŸ </span>ãƒ›ãƒ¼ãƒ </button>
        <button class="menu-btn" onclick="showScreen('party-screen', this); renderPartyScreen();"><span>ğŸ›¡ï¸</span>ç·¨æˆ</button>
        <button class="menu-btn" onclick="showScreen('gacha-screen', this)"><span>ğŸ’</span>ã‚¬ãƒãƒ£</button>
    </div>
</div>

<script>
    /* --- ãƒ‡ãƒ¼ã‚¿å®šç¾© --- */
    const CHAR_DB = [
        { id: 1, name: "æˆ¦å£«", rarity: "N", icon: "âš”ï¸", hp: 100, atk: 10 },
        { id: 2, name: "å¼“å…µ", rarity: "N", icon: "ğŸ¹", hp: 80, atk: 12 },
        { id: 3, name: "é­”æ³•ä½¿ã„", rarity: "R", icon: "ğŸ§™â€â™€ï¸", hp: 70, atk: 20 },
        { id: 4, name: "åƒ§ä¾¶", rarity: "R", icon: "âœï¸", hp: 90, atk: 5 },
        { id: 5, name: "è–é¨å£«", rarity: "SR", icon: "ğŸ›¡ï¸", hp: 200, atk: 15 },
        { id: 6, name: "æš—é»’é¨å£«", rarity: "SR", icon: "ğŸ¦‡", hp: 150, atk: 30 },
        { id: 7, name: "ç«œã®æˆ¦å£«", rarity: "SSR", icon: "ğŸ‰", hp: 300, atk: 50 },
        { id: 8, name: "å¤§å¤©ä½¿", rarity: "SSR", icon: "ğŸ‘¼", hp: 250, atk: 60 },
        { id: 9, name: "é­”ç‹", rarity: "SSR", icon: "ğŸ˜ˆ", hp: 400, atk: 80 }
    ];

    const ENEMY_DB = ["ğŸº", "ğŸ¦‡", "ğŸ", "ğŸ•·ï¸", "ğŸ—", "ğŸ‘»", "ğŸ‘¹", "ğŸ²"];

    /* --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ --- */
    let saveData = {
        gold: 1000,
        gems: 3000,
        ownedChars: [1, 2], // IDãƒªã‚¹ãƒˆ
        party: [1, 2, null], // 3æ 
        stage: 1
    };

    // ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    if(localStorage.getItem('gachaRPG_save')) {
        saveData = JSON.parse(localStorage.getItem('gachaRPG_save'));
    }

    let battleState = {
        active: false,
        wave: 1,
        maxWave: 3,
        enemyHp: 100,
        maxEnemyHp: 100,
        partyStatus: [], // {id, hp, maxHp}
        turn: 0,ãƒ¼
