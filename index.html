<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>MINIMALIST FPS PROTOTYPE</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        #crosshair {
            position: absolute;
            top: 50%; left: 50%;
            width: 20px; height: 20px;
            background-color: transparent;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none; /* マウスイベントを透過 */
        }
        #crosshair::after {
            content: ''; position: absolute;
            top: 50%; left: 50%;
            width: 4px; height: 4px;
            background-color: white;
            transform: translate(-50%, -50%);
            border-radius: 50%;
        }
        #info {
            position: absolute;
            top: 10px; left: 10px;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            pointer-events: none;
        }
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="crosshair"></div>
    <div id="info">Score: <span id="score">0</span></div>
    <div id="start-screen">
        <h1>MINIMALIST FPS</h1>
        <p>画面をクリックしてスタート</p>
        <p>マウス移動: 視点操作 | クリック: 射撃</p>
        <p>(ESCキーでカーソルを開放)</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>

    <script>
        let camera, scene, renderer, controls;
        let bullets = [];
        let enemies = [];
        let score = 0;
        let lastEnemySpawn = 0;
        const bulletSpeed = 5;
        const enemySpeed = 0.05;
        const scoreElement = document.getElementById('score');
        const startScreen = document.getElementById('start-screen');

        init();
        animate();

        function init() {
            // シーンの作成
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111111); //暗い背景
            scene.fog = new THREE.Fog(0x111111, 0, 500); // 霧で奥行き感を出す

            // カメラの作成
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 1.6; // 人間の目の高さ

            // ライティング
            const light = new THREE.HemisphereLight(0xffffff, 0x444444);
            light.position.set(0, 20, 0);
            scene.add(light);
            const dirLight = new THREE.DirectionalLight(0xffffff);
            dirLight.position.set(0, 10, 10);
            scene.add(dirLight);

            // 地面 (グリッド)
            const gridHelper = new THREE.GridHelper(1000, 100, 0x555555, 0x333333);
            scene.add(gridHelper);

            // レンダラーの作成
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // コントロール (FPS視点)
            controls = new THREE.PointerLockControls(camera, document.body);

            // スタート画面クリックでゲーム開始（ポインターロック）
            startScreen.addEventListener('click', () => {
                controls.lock();
            });

            controls.addEventListener('lock', () => {
                startScreen.style.display = 'none';
            });

            controls.addEventListener('unlock', () => {
                startScreen.style.display = 'flex';
                startScreen.innerHTML = `<h1>PAUSED</h1><p>クリックして再開</p>`;
            });

            // 射撃イベント
            document.addEventListener('click', () => {
                if (controls.isLocked) {
                    shoot();
                }
            });

            window.addEventListener('resize', onWindowResize);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function shoot() {
            // 弾丸の作成（小さな黄色い発光球体）
            const bullet Geometry = new THREE.SphereGeometry(0.1, 8, 8);
            const bulletMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
            const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);

            // 弾丸の発射位置をカメラの位置に設定
            bullet.position.copy(camera.position);
            
            // カメラが向いている方向を取得
            const direction = new THREE.Vector3();
            camera.getWorldDirection(direction);
            
            // 弾丸に速度ベクトルを持たせる
            bullet.velocity = direction.multiplyScalar(bulletSpeed);
            
            scene.add(bullet);
            bullets.push(bullet);
        }

        function spawnEnemy() {
            // 敵の作成（赤い立方体）
            const enemyGeometry = new THREE.BoxGeometry(2, 2, 2);
            const enemyMaterial = new THREE.MeshPhongMaterial({ color: 0xff0000 });
            const enemy = new THREE.Mesh(enemyGeometry, enemyMaterial);

            // ランダムな位置に出現（プレイヤーから一定距離離れた場所）
            const angle = Math.random() * Math.PI * 2;
            const radius = 50 + Math.random() * 50;
            enemy.position.x = Math.cos(angle) * radius;
            enemy.position.z = Math.sin(angle) * radius;
            enemy.position.y = 1; // 地面の上

            scene.add(enemy);
            enemies.push(enemy);
        }

        function animate() {
            requestAnimationFrame(animate);

            if (!controls.isLocked) return; // ポーズ中は更新しない

            const time = performance.now();

            // 一定間隔で敵をスポーン
            if (time - lastEnemySpawn > 2000) { // 2秒ごとにスポーン
                spawnEnemy();
                lastEnemySpawn = time;
            }

            // 弾丸の更新
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.position.add(bullet.velocity);

                // 遠すぎたら削除
                if (bullet.position.distanceTo(camera.position) > 200) {
                    scene.remove(bullet);
                    bullets.splice(i, 1);
                    continue;
                }

                // 衝突判定（弾丸 vs 敵）
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    // 簡易的な球体衝突判定
                    if (bullet.position.distanceTo(enemy.position) < 1.5) {
                        // 命中！
                        scene.remove(bullet);
                        bullets.splice(i, 1);
                        
                        scene.remove(enemy);
                        enemies.splice(j, 1);
                        
                        score += 100;
                        scoreElement.innerText = score;
                        break; // この弾丸はもう他の敵には当たらない
                    }
                }
            }

            // 敵の更新
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                // プレイヤーに向かって移動
                const direction = new THREE.Vector3();
                direction.subVectors(camera.position, enemy.position).normalize();
                enemy.position.add(direction.multiplyScalar(enemySpeed));
                
                // 敵が回転しながら迫ってくる演出
                enemy.rotation.x += 0.01;
                enemy.rotation.y += 0.02;

                // プレイヤーに到達したら（ゲームオーバー処理は今回は省略し、すり抜けるだけにする）
                if(enemy.position.distanceTo(camera.position) < 2) {
                     // 接近された！緊張感！
                }
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
