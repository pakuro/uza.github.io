<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>War Strategy: EASY MODE</title>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: 'Arial Black', sans-serif; user-select: none; }
        
        canvas { display: block; width: 100vw; height: 100vh; background: #87CEEB; }

        #ui-layer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 130px;
            background: rgba(0,0,0,0.85); border-top: 4px solid #fff;
            display: flex; justify-content: center; align-items: center; gap: 15px;
            padding-bottom: 10px; z-index: 10;
        }

        .btn {
            width: 110px; height: 90px;
            background: #444; color: white; border: 2px solid #666; border-radius: 8px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; transition: 0.1s;
            box-shadow: 0 4px 0 #222;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; background: #555; }
        .btn.disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); transform: none; box-shadow: none;}
        .cost { color: #ffff00; font-size: 14px; margin-top: 5px; }
        .name { font-size: 16px; font-weight: bold; }
        
        #btn-upgrade { background: #0055aa; border-color: #0077cc; }

        #money-display {
            position: absolute; top: -60px; left: 20px;
            color: #ffff00; font-size: 40px; text-shadow: 3px 3px 0 #000;
            font-family: 'Courier New', monospace; font-weight: bold;
        }

        #overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; display: none;
        }
        #overlay h1 { font-size: 60px; margin: 0; text-transform: uppercase; letter-spacing: 5px; }
        #restart-btn {
            margin-top: 30px; padding: 15px 50px; font-size: 24px; cursor: pointer;
            background: #fff; color: #000; border: none; font-weight: bold;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="money-display">MONEY: $0</div>
        
        <div class="btn" id="btn-soldier" onclick="spawnPlayerUnit('soldier')">
            <div class="name">SOLDIER</div>
            <div class="cost">$50</div>
        </div>
        
        <div class="btn" id="btn-tank" onclick="spawnPlayerUnit('tank')">
            <div class="name">TANK</div>
            <div class="cost">$200</div>
        </div>

        <div class="btn" id="btn-sniper" onclick="spawnPlayerUnit('sniper')">
            <div class="name">SNIPER</div>
            <div class="cost">$350</div>
        </div>

        <div style="border-left: 2px solid #666; height: 60px; margin: 0 10px;"></div>

        <div class="btn" id="btn-upgrade" onclick="upgradeWallet()">
            <div class="name">UPGRADE</div>
            <div class="cost" id="upg-cost">$500</div>
        </div>
    </div>

    <div id="overlay">
        <h1 id="result-text">VICTORY</h1>
        <button id="restart-btn" onclick="location.reload()">PLAY AGAIN</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const UNIT_TYPES = {
            soldier: { cost: 50,  hp: 60,  dmg: 12, range: 40,  speed: 2,   reload: 40,  bounty: 30,  color: '#33ff33', w: 10, h: 20 },
            tank:    { cost: 200, hp: 450, dmg: 45, range: 70,  speed: 1,   reload: 100, bounty: 150, color: '#3366ff', w: 40, h: 30 },
            sniper:  { cost: 350, hp: 50,  dmg: 90, range: 280, speed: 1.5, reload: 120, bounty: 200, color: '#ff33ff', w: 10, h: 25 }
        };

        let gameState = 'playing';
        let frame = 0;
        // ★初期資金 $500
        let money = 500; 
        // ★増加額ベース (レベルアップで増える)
        let moneyRate = 1; 
        let upgradeCost = 500;
        
        const GROUND_Y = window.innerHeight - 180;
        
        let units = [];
        let particles = [];
        let projectiles = [];
        let floatingTexts = [];

        const basePlayer = { x: 50, hp: 3000, maxHp: 3000, team: 'player', color: '#00ccff', w:60 };
        const baseEnemy = { x: window.innerWidth - 100, hp: 3000, maxHp: 3000, team: 'enemy', color: '#ff3333', w:60 };

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            baseEnemy.x = canvas.width - 100;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- Class Definitions ---
        class Unit {
            constructor(type, team) {
                const data = UNIT_TYPES[type];
                this.type = type;
                this.team = team;
                
                // プレイヤーユニットは1.3倍強化
                const buff = (team === 'player') ? 1.3 : 1.0;
                
                this.maxHp = data.hp * buff;
                this.hp = this.maxHp;
                this.dmg = data.dmg * buff;
                
                this.range = data.range;
                this.speed = data.speed;
                this.reloadTime = data.reload;
                this.color = data.color;
                this.w = data.w;
                this.h = data.h;
                this.bounty = data.bounty;
                this.cooldown = 0;
                this.state = 'move';
                this.dead = false;

                if (team === 'player') {
                    this.x = basePlayer.x + 60;
                    this.vx = this.speed;
                } else {
                    this.x = baseEnemy.x - 60;
                    this.vx = -this.speed;
                }
                this.y = GROUND_Y - this.h;
            }

            update() {
                if(this.dead) return;

                let target = null;
                let minDist = 9999;
                const enemyTeam = (this.team === 'player') ? 'enemy' : 'player';

                for(let u of units) {
                    if (u.team === enemyTeam && !u.dead) {
                        const dist = Math.abs(u.x - this.x);
                        if (dist < minDist) {
                            minDist = dist;
                            target = u;
                        }
                    }
                }

                const baseTarget = (this.team === 'player') ? baseEnemy : basePlayer;
                const baseDist = Math.abs(baseTarget.x - this.x);
                if (baseDist < minDist) {
                    minDist = baseDist;
                    target = baseTarget;
                    target.isBase = true;
                }

                if (target && minDist <= this.range) {
                    this.state = 'attack';
                    this.cooldown--;
                    if (this.cooldown <= 0) {
                        this.attack(target);
                        this.cooldown = this.reloadTime;
                    }
                } else {
                    this.state = 'move';
                    this.x += this.vx;
                    this.cooldown = Math.max(0, this.cooldown - 1);
                }
            }

            attack(target) {
                projectiles.push(new Projectile(this.x, this.y + this.h/2, target, this.dmg, this.team));
            }

            takeDamage(amount, attackerTeam) {
                this.hp -= amount;
                spawnParticles(this.x, this.y + this.h/2, 2, '#fff');
                
                if (this.hp <= 0 && !this.dead) {
                    this.dead = true;
                    if (this.team === 'enemy' && attackerTeam === 'player') {
                        money += this.bounty;
                        spawnFloatingText(this.x, this.y - 20, "+$" + this.bounty, '#ffff00');
                    }
                }
            }

            draw() {
                ctx.fillStyle = (this.team === 'enemy') ? '#ff5555' : this.color;
                if (this.type === 'tank') {
                    ctx.fillRect(this.x - this.w/2, this.y, this.w, this.h);
                    ctx.fillStyle = '#222';
                    ctx.fillRect(this.x + (this.team==='player'?5:-25), this.y-5, 20, 5);
                } else {
                    ctx.fillRect(this.x - this.w/2, this.y, this.w, this.h);
                    ctx.fillStyle = '#000';
                    ctx.fillRect(this.x, this.y + 8, (this.team==='player'?15:-15), 2);
                }
                const pct = Math.max(0, this.hp / this.maxHp);
                ctx.fillStyle = '#444';
                ctx.fillRect(this.x - 10, this.y - 8, 20, 4);
                ctx.fillStyle = (this.team === 'player') ? '#00ff00' : '#ff0000';
                ctx.fillRect(this.x - 10, this.y - 8, 20 * pct, 4);
            }
        }

        class Projectile {
            constructor(x, y, target, dmg, team) {
                this.x = x; this.y = y; this.target = target;
                this.dmg = dmg; this.team = team; this.speed = 10; this.active = true;
                const tx = (target.isBase) ? target.x : target.x;
                const ty = (target.isBase) ? (GROUND_Y - 40) : (target.y + 10);
                const dx = tx - x; const dy = ty - y;
                const d = Math.sqrt(dx*dx + dy*dy);
                this.vx = (dx/d) * this.speed; this.vy = (dy/d) * this.speed;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                let hit = false;
                if (this.target.isBase) {
                    if (Math.abs(this.x - this.target.x) < 50) { this.target.hp -= this.dmg; hit = true; }
                } else if (!this.target.dead) {
                    if (Math.abs(this.x - this.target.x) < 20 && Math.abs(this.y - (this.target.y + 10)) < 20) {
                        this.target.takeDamage(this.dmg, this.team); hit = true;
                    }
                } else { if (Math.abs(this.x - this.target.x) < 10) this.active = false; }
                if (hit) { this.active = false; spawnParticles(this.x, this.y, 4, 'orange'); }
                if (this.x < 0 || this.x > canvas.width) this.active = false;
            }
            draw() { ctx.fillStyle = '#ffff00'; ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI*2); ctx.fill(); }
        }

        class FloatingText {
            constructor(x, y, text, color) { this.x=x; this.y=y; this.text=text; this.color=color; this.life=1.0; this.vy=-1.5; }
            update() { this.y+=this.vy; this.life-=0.02; }
            draw() {
                ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle = this.color;
                ctx.font = "bold 20px Arial"; ctx.strokeStyle="black"; ctx.lineWidth=3;
                ctx.strokeText(this.text, this.x, this.y); ctx.fillText(this.text, this.x, this.y);
                ctx.globalAlpha = 1.0;
            }
        }
        class Particle {
            constructor(x, y, color) { this.x=x; this.y=y; this.color=color; this.vx=(Math.random()-0.5)*6; this.vy=(Math.random()-0.5)*6; this.life=1.0; }
            update() { this.x+=this.vx; this.y+=this.vy; this.life-=0.05; }
            draw() { ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle=this.color; ctx.fillRect(this.x, this.y, 4, 4); ctx.globalAlpha=1.0; }
        }
        function spawnParticles(x, y, c, col) { for(let i=0; i<c; i++) particles.push(new Particle(x,y,col)); }
        function spawnFloatingText(x, y, txt, col) { floatingTexts.push(new FloatingText(x, y, txt, col)); }

        function spawnPlayerUnit(type) {
            if (gameState !== 'playing') return;
            const cost = UNIT_TYPES[type].cost;
            if (money >= cost) {
                money -= cost;
                units.push(new Unit(type, 'player'));
            }
        }

        function upgradeWallet() {
            if (money >= upgradeCost) {
                money -= upgradeCost;
                moneyRate += 1; 
                upgradeCost += 500;
                document.getElementById('upg-cost').innerText = "$" + upgradeCost;
                spawnFloatingText(basePlayer.x, basePlayer.y - 100, "LEVEL UP!!", "#00ffff");
            }
        }

        let enemyTimer = 0;
        function updateEnemyAI() {
            if(gameState !== 'playing') return;
            enemyTimer++;
            
            // ★敵の出現ペースを大幅ダウン（200フレーム以上間隔）
            // 以前は 120 - (frame/300) だった
            let spawnInterval = 250 - (frame / 500); 
            if(spawnInterval < 100) spawnInterval = 100; // 最速でも遅め

            if (enemyTimer > spawnInterval) {
                const r = Math.random();
                let type = 'soldier';
                // 強い敵が出る確率も下げる
                if (r < 0.2 && frame > 1000) type = 'tank';
                if (r < 0.05 && frame > 2000) type = 'sniper';
                
                units.push(new Unit(type, 'enemy'));
                enemyTimer = 0;
            }
        }

        function update() {
            if (gameState !== 'playing') return;
            frame++;

            // ★お金増加ロジック変更：6フレーム(約0.1秒)ごとに加算
            // これで moneyRate=1 なら秒間10コイン、moneyRate=5なら秒間50コイン
            if (frame % 6 === 0) {
                money += moneyRate;
            }
            document.getElementById('money-display').innerText = "MONEY: $" + Math.floor(money);
            
            ['soldier', 'tank', 'sniper'].forEach(type => {
                const btn = document.getElementById('btn-'+type);
                if (money >= UNIT_TYPES[type].cost) btn.classList.remove('disabled');
                else btn.classList.add('disabled');
            });
            const upgBtn = document.getElementById('btn-upgrade');
            if (money >= upgradeCost) upgBtn.classList.remove('disabled');
            else upgBtn.classList.add('disabled');

            updateEnemyAI();

            units.forEach(u => u.update());
            units = units.filter(u => !u.dead);

            projectiles.forEach(p => p.update());
            projectiles = projectiles.filter(p => p.active);

            particles.forEach(p => p.update());
            particles = particles.filter(p => p.life > 0);

            floatingTexts.forEach(t => t.update());
            floatingTexts = floatingTexts.filter(t => t.life > 0);

            if (basePlayer.hp <= 0) endGame(false);
            if (baseEnemy.hp <= 0) endGame(true);
        }

        function draw() {
            const grd = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grd.addColorStop(0, "#00BFFF");
            grd.addColorStop(1, "#87CEEB");
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#2d8f2d';
            ctx.fillRect(0, GROUND_Y, canvas.width, canvas.height - GROUND_Y);
            ctx.fillStyle = '#257025';
            ctx.fillRect(0, GROUND_Y, canvas.width, 10);

            drawBase(basePlayer);
            drawBase(baseEnemy);

            units.forEach(u => u.draw());
            projectiles.forEach(p => p.draw());
            particles.forEach(p => p.draw());
            floatingTexts.forEach(t => t.draw());

            requestAnimationFrame(() => {
                update();
                draw();
            });
        }

        function drawBase(base) {
            ctx.fillStyle = base.color;
            ctx.beginPath();
            ctx.arc(base.x, GROUND_Y, 70, Math.PI, 0);
            ctx.fill();
            const pct = Math.max(0, base.hp / base.maxHp);
            ctx.fillStyle = '#000';
            ctx.fillRect(base.x - 50, GROUND_Y - 110, 100, 12);
            ctx.fillStyle = (pct > 0.3) ? '#00ff00' : 'red';
            ctx.fillRect(base.x - 50, GROUND_Y - 110, 100 * pct, 12);
            ctx.strokeStyle = '#fff';
            ctx.strokeRect(base.x - 50, GROUND_Y - 110, 100, 12);
        }

        function endGame(win) {
            gameState = (win) ? 'win' : 'lose';
            const ov = document.getElementById('overlay');
            const txt = document.getElementById('result-text');
            ov.style.display = 'flex';
            if (win) {
                txt.innerText = "VICTORY!!";
                txt.style.color = "#00ffcc";
            } else {
                txt.innerText = "DEFEAT...";
                txt.style.color = "#ff3333";
            }
        }

        draw();
    </script>
</body>
</html>
